<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="4.4-20251214-FINAL">
    <meta name="force-reload" content="true">
    <title>Gitesh Life Tracker v4.4 CLEAN</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%234F46E5'/><text x='50' y='50' text-anchor='middle' dominant-baseline='central' font-size='60' fill='white' font-weight='bold'>✓</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --primary-dark: #4338CA;
            --accent: #8B5CF6;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #fafbfd 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-size: 26px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 24px;
            font-weight: 400;
        }

        .lists-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .list-section {
            background: white;
            padding: 24px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: box-shadow 0.2s;
        }

        .list-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        h2 {
            font-size: 17px;
            color: #1a1a1a;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .recommend-btn {
            background: #fff;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .recommend-btn:hover {
            background: #f8f9fa;
            border-color: #999;
            color: #333;
        }

        .recommendation {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            margin-bottom: 16px;
            font-size: 13px;
            color: #333;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .recommendation.empty {
            color: #999;
            font-style: italic;
        }

        .change-btn {
            background: #fff;
            border: 1px solid #e0e0e0;
            color: #666;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .change-btn:hover {
            background: #f8f9fa;
            border-color: #999;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.03);
        }

        .add-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
        }

        .add-btn:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .add-btn:active {
            transform: translateY(0);
        }

        .checklist {
            list-style: none;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 11px 10px;
            margin-bottom: 6px;
            background: #fafafa;
            border: 1px solid transparent;
            border-radius: 6px;
            transition: all 0.15s;
            min-width: 0;
        }

        .checklist-item:hover {
            background: #f5f5f5;
            border-color: #e8e8e8;
        }

        .checklist-item.completed {
            opacity: 0.5;
        }

        .checklist-item.completed .item-text {
            text-decoration: line-through;
            color: #999;
        }

        input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .item-text {
            flex: 1 1 0;
            min-width: 0;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            user-select: none;
            word-break: normal;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .item-text:hover {
            color: #007bff;
        }

        .move-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 6px;
            transition: all 0.15s;
            font-weight: 500;
        }

        .move-btn:hover {
            background: #fff;
            border-color: #999;
            color: #333;
        }

        .delete-btn {
            background: transparent;
            color: #dc3545;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: all 0.15s;
            font-weight: 500;
        }

        .checklist-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }

        /* Daily Habits Tracker */
        .daily-habits {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .daily-habits:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Weight Tracker */
        .weight-tracker {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .weight-tracker:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .weight-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .weight-log {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .weight-log::-webkit-scrollbar {
            width: 6px;
        }

        .weight-log::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        .weight-log::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .weight-log::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .weight-entry {
            background: #fafafa;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s;
        }

        .weight-entry:hover {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .weight-value {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .weight-date {
            font-size: 11px;
            color: #999;
            margin-left: 8px;
        }

        .weight-delete {
            background: transparent;
            color: #dc3545;
            border: 1px solid transparent;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: all 0.15s;
            font-weight: 500;
        }

        .weight-entry:hover .weight-delete {
            opacity: 1;
        }

        .weight-delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Notes Section */
        .notes-section {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .notes-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .notes-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .notes-list::-webkit-scrollbar {
            width: 6px;
        }

        .notes-list::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        .notes-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .notes-list::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .note-item {
            background: #fafafa;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            transition: all 0.15s;
            position: relative;
        }

        .note-item:hover {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .note-content {
            font-size: 13px;
            color: #333;
            margin-bottom: 6px;
            word-wrap: break-word;
            line-height: 1.5;
            cursor: pointer;
        }

        .note-content:hover {
            color: #007bff;
        }

        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-timestamp {
            font-size: 10px;
            color: #999;
        }

        .note-delete {
            background: transparent;
            color: #dc3545;
            border: 1px solid transparent;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: all 0.15s;
            font-weight: 500;
        }

        .note-item:hover .note-delete {
            opacity: 1;
        }

        .note-delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .daily-habits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .daily-habits-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .daily-habits-date {
            font-size: 11px;
            color: #999;
            font-weight: 500;
        }

        .habits-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 6px;
        }

        .habit-btn {
            background: #fafafa;
            border: 1.5px solid #e0e0e0;
            color: #666;
            padding: 8px 6px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 48px;
        }

        .habit-btn:hover {
            background: #f5f5f5;
            border-color: #999;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .habit-btn.completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10B981;
            color: #065f46;
            font-weight: 600;
        }

        .habit-btn.completed .habit-check {
            opacity: 1;
        }

        .habit-text {
            font-size: 9.5px;
            line-height: 1.2;
            text-align: center;
            margin-bottom: 2px;
        }

        .habit-streak {
            font-size: 8px;
            color: #f59e0b;
            font-weight: 700;
            display: inline-block;
            margin-left: 2px;
        }

        .habit-check {
            opacity: 0;
            font-size: 14px;
            transition: opacity 0.2s;
            position: absolute;
            top: 2px;
            right: 3px;
        }

        /* Tablet/Medium screens */
        @media (max-width: 1024px) and (min-width: 769px) {
            .habits-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .habit-btn {
                padding: 9px 5px;
                font-size: 10px;
                min-height: 46px;
            }

            .habit-text {
                font-size: 9.5px;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .daily-habits {
                padding: 10px;
            }

            .habits-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }

            .habit-btn {
                padding: 8px 4px;
                font-size: 9px;
                min-height: 44px;
            }

            .habit-text {
                font-size: 9px;
            }

            .habit-check {
                font-size: 12px;
                top: 2px;
                right: 2px;
            }

            .daily-habits-title {
                font-size: 12px;
            }

            .daily-habits-date {
                font-size: 10px;
            }
        }

        .list-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .task-counter {
            font-size: 13px;
            color: #666;
        }

        .clear-completed-btn {
            background: #fff;
            border: 1px solid #e0e0e0;
            color: #666;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .clear-completed-btn:hover:not(:disabled) {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .clear-completed-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Clean minimal button styles */
        .action-btn {
            background: #fff;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 7px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f8f9fa;
            border-color: #999;
            color: #333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .action-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #search-input:focus {
            border-color: #999;
            outline: none;
        }

        .sync-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .sync-status.synced { background: #d1fae5; color: #065f46; }
        .sync-status.syncing {
            background: #e0e7ff;
            color: var(--primary-dark);
            animation: pulse 1.5s ease-in-out infinite;
        }
        .sync-status.offline { background: #fef3c7; color: #92400e; }
        .sync-status.error { background: #fee2e2; color: #991b1b; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
            }

            .container {
                max-width: 100%;
                overflow-x: hidden;
            }

            h1 {
                font-size: 16px;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 10px;
                margin-bottom: 10px;
            }

            #search-input {
                font-size: 13px !important;
                padding: 10px 12px !important;
                max-width: 100% !important;
                flex: 1 1 auto !important;
                min-width: 150px !important;
            }

            #search-input + button {
                font-size: 12px !important;
                padding: 10px 14px !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }

            #change-global-rec {
                font-size: 12px !important;
                padding: 10px 14px !important;
                flex-shrink: 0 !important;
            }

            #global-recommendation {
                padding: 12px 14px !important;
                margin-bottom: 8px !important;
            }

            #global-recommendation #rec-type {
                font-size: 10px !important;
            }

            #global-recommendation #rec-content {
                font-size: 13px !important;
            }

            #global-recommendation #rec-meta {
                font-size: 10px !important;
            }

            .container > div > div button:not(#change-global-rec):not([onclick*="getGlobalRecommendation"]) {
                font-size: 11px !important;
                padding: 6px 10px !important;
            }

            .lists-container {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .list-section {
                padding: 8px;
                min-width: 0;
                overflow: hidden;
                word-break: normal;
            }

            h2 {
                font-size: 12px;
            }

            .list-header {
                margin-bottom: 8px;
                flex-wrap: wrap;
            }

            .list-header > div {
                display: flex;
                gap: 3px;
                flex-wrap: wrap;
            }

            .recommend-btn {
                font-size: 9px;
                padding: 4px 6px;
            }

            .recommendation {
                font-size: 12px;
                padding: 10px;
                min-height: 40px;
                margin-bottom: 10px;
                word-break: normal;
                overflow-wrap: break-word;
            }

            .input-group {
                margin-bottom: 10px;
                gap: 6px;
                display: flex;
                flex-wrap: nowrap;
            }

            input[type="text"] {
                font-size: 12px;
                padding: 8px;
                min-width: 0;
                flex: 1;
            }

            .add-btn {
                font-size: 11px;
                padding: 8px 10px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .checklist-item {
                padding: 8px 6px;
                margin-bottom: 4px;
                display: flex !important;
                align-items: center;
                flex-wrap: nowrap !important;
                word-break: normal !important;
            }

            .item-text {
                font-size: 11px !important;
                word-break: normal !important;
                overflow-wrap: break-word !important;
                white-space: normal !important;
                line-height: 1.3;
                flex: 1 1 auto;
                min-width: 0;
                max-width: 100%;
            }

            .checklist-item .item-text {
                word-break: normal !important;
                overflow-wrap: break-word !important;
                white-space: normal !important;
            }

            .list-section .checklist .checklist-item .item-text {
                word-break: normal !important;
            }

            .move-btn {
                font-size: 12px;
                padding: 2px 4px;
                margin-right: 4px;
            }

            .delete-btn {
                font-size: 10px;
                padding: 4px 8px;
                opacity: 0;
                transition: opacity 0.2s;
            }

            .checklist-item.show-delete .delete-btn {
                opacity: 1;
            }

            .change-btn {
                font-size: 9px;
                padding: 2px 4px;
            }

            .clear-completed-btn {
                font-size: 9px;
                padding: 3px 5px;
            }

            input[type="checkbox"] {
                width: 14px;
                height: 14px;
                margin-right: 6px;
            }

            .task-counter {
                font-size: 10px;
            }

            .list-footer {
                margin-top: 8px;
                padding-top: 8px;
                flex-wrap: wrap;
                gap: 5px;
            }

            .list-footer > div {
                display: flex;
                gap: 3px;
                flex-wrap: wrap;
            }

            .empty-state {
                font-size: 12px;
                padding: 15px;
            }

            select {
                font-size: 13px !important;
                padding: 10px !important;
            }

            input[type="number"] {
                font-size: 13px !important;
                padding: 10px !important;
            }

            .weight-delete,
            .note-delete {
                opacity: 1; /* Always show on mobile since no hover */
            }
        }

        /* Dashboard Summary */
        .dashboard-summary {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: box-shadow 0.2s;
        }

        .dashboard-summary:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .dashboard-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #e8e8e8;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .dashboard-card:hover {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .dashboard-card-header {
            font-size: 11px;
            font-weight: 500;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .dashboard-card-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            line-height: 1.2;
        }

        .dashboard-card-subtitle {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dashboard-card-trend {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .dashboard-card-trend.positive {
            background: #d1fae5;
            color: #059669;
        }

        .dashboard-card-trend.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .dashboard-card-trend.neutral {
            background: #e0e7ff;
            color: #4f46e5;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .dashboard-card {
                padding: 10px;
            }

            .dashboard-card-value {
                font-size: 20px;
            }

            .dashboard-summary {
                padding: 12px 16px;
            }
        }

        /* Attachment Styles */
        .attach-btn {
            background: transparent;
            color: #666;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: all 0.15s;
            font-weight: 500;
            margin-left: 4px;
        }

        .checklist-item:hover .attach-btn {
            opacity: 1;
        }

        .attach-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            color: #333;
        }

        .attachments-container {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e8e8e8;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .attachment-item {
            display: inline-flex;
            align-items: center;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            transition: all 0.15s;
            max-width: 200px;
        }

        .attachment-item:hover {
            background: #e9ecef;
            border-color: #999;
        }

        .attachment-icon {
            margin-right: 4px;
            font-size: 12px;
        }

        .attachment-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .attachment-delete {
            margin-left: 6px;
            color: #dc3545;
            cursor: pointer;
            font-size: 10px;
            opacity: 0.7;
            transition: opacity 0.15s;
        }

        .attachment-delete:hover {
            opacity: 1;
        }

        .attachment-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            transition: all 0.15s;
        }

        .attachment-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Documents Section */
        .documents-section {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .documents-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .documents-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .documents-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .documents-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .documents-list::-webkit-scrollbar {
            width: 6px;
        }

        .documents-list::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        .documents-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        .documents-list::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .document-item {
            background: #fafafa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .document-item:hover {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e0e7ff;
            border-radius: 6px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .document-icon.pdf { background: #fee2e2; color: #dc2626; }
        .document-icon.doc { background: #dbeafe; color: #1e40af; }
        .document-icon.xls { background: #d1fae5; color: #065f46; }
        .document-icon.img { background: #fef3c7; color: #92400e; }
        .document-icon.other { background: #e5e7eb; color: #4b5563; }

        .document-info {
            flex: 1;
            min-width: 0;
        }

        .document-name {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .document-name:hover {
            color: #007bff;
        }

        .document-meta {
            font-size: 10px;
            color: #999;
            display: flex;
            gap: 10px;
        }

        .document-actions {
            display: flex;
            gap: 6px;
        }

        .document-preview-btn,
        .document-download-btn,
        .document-delete-btn {
            background: transparent;
            border: 1px solid #e0e0e0;
            color: #666;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .document-preview-btn:hover,
        .document-download-btn:hover {
            background: #f8f9fa;
            border-color: #999;
            color: #333;
        }

        .document-delete-btn {
            color: #dc3545;
            opacity: 0;
        }

        .document-item:hover .document-delete-btn {
            opacity: 1;
        }

        .document-delete-btn:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #999;
            background: #fafafa;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #f0f0ff;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
            color: #999;
        }

        .upload-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: 11px;
            color: #999;
        }

        .file-input-hidden {
            display: none;
        }

        /* Image Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

        .preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 36px;
            color: white;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .preview-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .attach-btn {
                opacity: 1;
                font-size: 16px;
                padding: 6px 10px;
            }

            .attachment-item {
                max-width: 150px;
            }

            .attachment-thumbnail {
                width: 50px;
                height: 50px;
            }

            .document-item {
                flex-wrap: wrap;
            }

            .document-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 8px;
            }

            .document-delete-btn {
                opacity: 1;
            }

            .upload-area {
                padding: 16px;
            }

            .upload-icon {
                font-size: 28px;
            }
        }

        /* Birthday Tracker Section */
        .birthday-section {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .birthday-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .birthday-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .birthday-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .birthday-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .birthday-item {
            background: #fafafa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .birthday-item:hover {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .birthday-item.upcoming {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fbbf24;
        }

        .birthday-item.today {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border-color: #ec4899;
            animation: pulse-birthday 2s ease-in-out infinite;
        }

        @keyframes pulse-birthday {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .birthday-info {
            flex: 1;
        }

        .birthday-name {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .birthday-date {
            font-size: 11px;
            color: #666;
        }

        .birthday-delete {
            background: #fff;
            color: #999;
            border: 1px solid #e0e0e0;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .birthday-delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .birthday-notification {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border: 2px solid #ec4899;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            animation: slide-down 0.3s ease-out;
        }

        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .birthday-notification-text {
            font-size: 13px;
            font-weight: 600;
            color: #831843;
            text-align: center;
        }

        /* Reminders Section */
        .reminders-section {
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .reminders-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .reminders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .reminders-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.3px;
        }

        .reminders-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .reminder-item {
            background: #fafafa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .reminder-item:hover {
            background: #f5f5f5;
            border-color: #ddd;
        }

        .reminder-item.due-soon {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fbbf24;
        }

        .reminder-item.overdue {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
        }

        .reminder-info {
            flex: 1;
        }

        .reminder-name {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .reminder-details {
            font-size: 11px;
            color: #666;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .reminder-frequency {
            padding: 2px 6px;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .reminder-delete {
            background: #fff;
            color: #999;
            border: 1px solid #e0e0e0;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .reminder-delete:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .reminder-notification {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #f87171;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            animation: slide-down 0.3s ease-out;
        }

        .reminder-notification-text {
            font-size: 13px;
            font-weight: 600;
            color: #991b1b;
            text-align: center;
        }

        /* Password Protection */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #fafbfd 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        .password-container {
            background: white;
            padding: 48px;
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            text-align: center;
            max-width: 420px;
            width: 90%;
        }

        .password-title {
            font-size: 26px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .password-subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 32px;
            font-weight: 400;
        }

        .password-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
            transition: all 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .password-button {
            width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
        }

        .password-button:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .password-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 12px;
            display: none;
            background: #fee;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #fcc;
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="password-overlay" class="password-overlay">
        <div class="password-container">
            <div class="password-title">Gitesh Life Tracker</div>
            <div class="password-subtitle">Enter password to access your tracker</div>
            <input type="password" id="password-input" class="password-input" placeholder="Enter password" onkeypress="handlePasswordKeyPress(event)" autofocus>
            <button class="password-button" onclick="checkPassword()">Unlock Access</button>
            <div id="password-error" class="password-error">Incorrect password. Please try again.</div>
        </div>
    </div>

    <div class="container" id="main-content" style="display: none;">
        <h1>Gitesh Life Tracker <span style="font-size: 12px; color: #999; font-weight: 400;">v4.4</span></h1>
        <div style="text-align: center; margin-bottom: 8px;">
            <div id="indian-datetime" style="font-size: 13px; color: #666; font-weight: 500;"></div>
        </div>
        <p class="subtitle">Double-click goals to edit • Use → button to move between lists • <span id="sync-status" class="sync-status synced">Auto-Synced</span></p>

        <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 8px; justify-content: center; align-items: center; margin-bottom: 12px; flex-wrap: wrap;">
                <input type="text" id="search-input" placeholder="Search goals, notes, and documents..." style="flex: 1 1 auto; max-width: 320px; min-width: 200px; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.2s;" oninput="handleSearch()">
                <button onclick="getGlobalRecommendation()" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2); white-space: nowrap;" title="Get a smart recommendation from all your data" onmouseover="this.style.background='linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(79, 70, 229, 0.3)'" onmouseout="this.style.background='linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(79, 70, 229, 0.2)'">Recommend</button>
                <button onclick="changeGlobalRecommendation()" id="change-global-rec" style="background: #fff; color: #666; border: 1px solid #e0e0e0; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; white-space: nowrap; display: none;" title="Get a different recommendation" onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#999'; this.style.color='#333'" onmouseout="this.style.background='#fff'; this.style.borderColor='#e0e0e0'; this.style.color='#666'">Change</button>
            </div>

            <!-- Global Recommendation Display -->
            <div id="global-recommendation" style="display: none; background: linear-gradient(135deg, #f0f4ff 0%, #f8f5ff 100%); border: 2px solid var(--primary); padding: 16px 20px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15); max-width: 600px; margin-left: auto; margin-right: auto;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; font-weight: 600; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;" id="rec-type"></div>
                        <div style="font-size: 15px; font-weight: 600; color: #1a1a1a; line-height: 1.4;" id="rec-content"></div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;" id="rec-meta"></div>
                    </div>
                    <button onclick="dismissRecommendation()" style="background: transparent; color: #999; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 18px; line-height: 1; transition: all 0.15s;" title="Dismiss" onmouseover="this.style.color='#333'; this.style.background='rgba(0,0,0,0.05)'" onmouseout="this.style.color='#999'; this.style.background='transparent'">×</button>
                </div>
            </div>

            <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; align-items: center; padding: 4px 0;">
                <button onclick="undo()" style="background: #fff; color: #666; border: 1px solid #e0e0e0; padding: 7px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; white-space: nowrap;" title="Undo last action (Ctrl+Z)">Undo</button>
                <button onclick="showStats()" style="background: #fff; color: #666; border: 1px solid #e0e0e0; padding: 7px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; white-space: nowrap;">Stats</button>
                <button onclick="exportData()" style="background: #fff; color: #666; border: 1px solid #e0e0e0; padding: 7px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; white-space: nowrap;" title="Download backup JSON">Export</button>
                <button onclick="document.getElementById('import-file').click()" style="background: #fff; color: #666; border: 1px solid #e0e0e0; padding: 7px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; white-space: nowrap;" title="Upload backup JSON">Import</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>

        <!-- Dashboard Summary -->
        <div class="dashboard-summary">
            <div class="dashboard-grid" id="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-header">Active Goals</div>
                    <div class="dashboard-card-value" id="dashboard-goals-count">0</div>
                    <div class="dashboard-card-subtitle" id="dashboard-goals-subtitle">Loading...</div>
                </div>

                <div class="dashboard-card">
                    <div class="dashboard-card-header">Today's Habits</div>
                    <div class="dashboard-card-value" id="dashboard-habits-percent">0%</div>
                    <div class="dashboard-card-subtitle" id="dashboard-habits-subtitle">0/9 completed</div>
                </div>

                <div class="dashboard-card">
                    <div class="dashboard-card-header">Best Streak</div>
                    <div class="dashboard-card-value" id="dashboard-best-streak">0</div>
                    <div class="dashboard-card-subtitle" id="dashboard-streak-subtitle">No active streaks</div>
                </div>

                <div class="dashboard-card">
                    <div class="dashboard-card-header">Weight</div>
                    <div class="dashboard-card-value" id="dashboard-weight-value">--</div>
                    <div class="dashboard-card-subtitle" id="dashboard-weight-subtitle">No data yet</div>
                </div>
            </div>
        </div>

        <!-- Water Tracker -->
        <div class="daily-habits" style="margin-bottom: 16px;">
            <div class="daily-habits-header">
                <h3 class="daily-habits-title">Water Tracker <span id="water-progress" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e3a8a; padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0/8</span></h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 11px; color: #64748b;" id="water-date">Today</span>
                    <button class="recommend-btn" onclick="resetWater()" style="font-size: 10px; padding: 5px 10px;">Reset</button>
                </div>
            </div>
            <div id="water-glasses" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px 0;"></div>
            <div id="water-log-container" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e8e8e8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h4 style="font-size: 12px; font-weight: 600; color: #374151; margin: 0;">Today's Log</h4>
                        <button class="recommend-btn" onclick="toggleWaterLog()" id="water-log-toggle" style="font-size: 10px; padding: 4px 8px;">▼</button>
                    </div>
                    <div id="water-log-list" style="font-size: 11px; color: #64748b; max-height: 120px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Daily Habits Tracker -->
        <div class="daily-habits">
            <div class="daily-habits-header">
                <h3 class="daily-habits-title">Daily Habits <span id="habits-progress" style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); color: var(--primary-dark); padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0/9</span></h3>
                <span class="daily-habits-date" id="habits-date">Today</span>
            </div>
            <div class="habits-grid" role="group" aria-label="Daily habits tracker">
                <button class="habit-btn" onclick="toggleHabit('icefacial')" id="habit-icefacial" aria-label="Ice Facial daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">Ice Facial <span class="habit-streak" id="streak-icefacial"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('workout')" id="habit-workout" aria-label="10k steps daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">10K Steps <span class="habit-streak" id="streak-workout"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('temple')" id="habit-temple" aria-label="Temple visit daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">Temple Visit <span class="habit-streak" id="streak-temple"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('meditation')" id="habit-meditation" aria-label="Meditation daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">Meditation <span class="habit-streak" id="streak-meditation"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('noBadHabits')" id="habit-noBadHabits" aria-label="No smoking daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">No Smoking <span class="habit-streak" id="streak-noBadHabits"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('learning')" id="habit-learning" aria-label="Audiobook or learning daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">Audiobook / Learning <span class="habit-streak" id="streak-learning"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('protein')" id="habit-protein" aria-label="No fap or porn daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">No Fap / Porn <span class="habit-streak" id="streak-protein"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('skincare')" id="habit-skincare" aria-label="Skincare daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">Skincare <span class="habit-streak" id="streak-skincare"></span></span>
                </button>
                <button class="habit-btn" onclick="toggleHabit('supplements')" id="habit-supplements" aria-label="Supplements daily habit">
                    <span class="habit-check" aria-hidden="true">✓</span>
                    <span class="habit-text">Supplements <span class="habit-streak" id="streak-supplements"></span></span>
                </button>
            </div>
        </div>

        <!-- Weight Tracker -->
        <div class="weight-tracker">
            <div class="weight-header">
                <h3 class="weight-title">Weight Tracker <span id="weight-count" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0 logs</span></h3>
                <button class="recommend-btn" onclick="toggleWeightSection()" id="weight-toggle-btn" style="font-size: 12px; padding: 5px 10px; font-weight: 600;">▼</button>
            </div>

            <div id="weight-content" style="overflow: hidden; transition: max-height 0.3s ease-out;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0;">
                    <input type="number" id="height-input" placeholder="Height (cm)" step="1" min="100" max="250" onchange="saveHeightAndTarget()" style="padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 12px;">
                    <input type="number" id="target-weight-input" placeholder="Target (kg)" step="0.1" min="0" max="300" onchange="saveHeightAndTarget()" style="padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 12px;">
                </div>

                <div class="input-group" style="margin-bottom: 12px;">
                    <input type="number" id="weight-input" placeholder="Enter weight (kg)" step="0.1" min="0" max="300" onkeypress="handleWeightKeyPress(event)" style="flex: 1; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                    <button class="add-btn" onclick="addWeight()" style="padding: 10px 18px;">Log Weight</button>
                </div>

                <div id="weight-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px;">
                    <div style="text-align: center; padding: 10px; background: #f0f9ff; border-radius: 6px; border: 1px solid #e0f2fe;">
                        <div style="font-size: 18px; font-weight: 600; color: #0369a1;" id="current-weight">--</div>
                        <div style="font-size: 10px; color: #0369a1; margin-top: 2px;">Current</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #dcfce7;">
                        <div style="font-size: 18px; font-weight: 600; color: #15803d;" id="weight-change-prev">--</div>
                        <div style="font-size: 10px; color: #15803d; margin-top: 2px;">vs Previous</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #dcfce7;">
                        <div style="font-size: 18px; font-weight: 600; color: #15803d;" id="weight-change-total">--</div>
                        <div style="font-size: 10px; color: #15803d; margin-top: 2px;">Total Change</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px; border: 1px solid #fde68a;">
                        <div style="font-size: 18px; font-weight: 600; color: #92400e;" id="start-weight">--</div>
                        <div style="font-size: 10px; color: #92400e; margin-top: 2px;">Start</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #fce7f3; border-radius: 6px; border: 1px solid #fbcfe8;">
                        <div style="font-size: 18px; font-weight: 600; color: #9f1239;" id="bmi-value">--</div>
                        <div style="font-size: 10px; color: #9f1239; margin-top: 2px;" id="bmi-category">BMI</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #ede9fe; border-radius: 6px; border: 1px solid #ddd6fe;">
                        <div style="font-size: 18px; font-weight: 600; color: #6b21a8;" id="target-progress">--</div>
                        <div style="font-size: 10px; color: #6b21a8; margin-top: 2px;">To Target</div>
                    </div>
                </div>

                <div style="background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e5e7eb;">
                    <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Weight Trend</div>
                    <canvas id="weight-chart" style="width: 100%; height: 200px;"></canvas>
                </div>

                <div id="weight-log" class="weight-log"></div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="notes-header" onclick="toggleNotesSection()" style="cursor: pointer;" title="Click to expand/collapse">
                <h3 class="notes-title">Quick Notes <span id="notes-count" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0</span></h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="recommend-btn" onclick="event.stopPropagation(); clearAllNotes()" style="font-size: 10px; padding: 5px 10px;">Clear All</button>
                    <button class="recommend-btn" id="notes-toggle-btn" style="font-size: 12px; padding: 5px 10px; font-weight: 600;">▼</button>
                </div>
            </div>

            <div id="notes-content" style="overflow: hidden; transition: max-height 0.3s ease-out;">
                <div style="margin-bottom: 12px; padding-top: 8px;">
                    <input type="text" id="notes-search" placeholder="Search notes..." style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 12px; margin-bottom: 10px;" oninput="searchNotes()">
                </div>

                <div class="input-group" style="margin-bottom: 12px;">
                    <input type="text" id="note-input" placeholder="Add a quick note..." onkeypress="handleNoteKeyPress(event)" maxlength="500" style="flex: 1; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                    <button class="add-btn" onclick="addNote()" style="padding: 10px 18px;">Add Note</button>
                </div>
                <div style="text-align: right; font-size: 10px; color: #999; margin-top: -8px; margin-bottom: 12px;">
                    <span id="note-char-count">0/500</span>
                </div>

                <div id="notes-list" class="notes-list">
                    <div class="empty-state">No notes yet. Add one above!</div>
                </div>
            </div>
        </div>

        <!-- Documents Section -->
        <div class="documents-section">
            <div class="documents-header" onclick="toggleDocumentsSection()" style="cursor: pointer;" title="Click to expand/collapse">
                <h3 class="documents-title">Documents <span id="documents-count" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0</span></h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="recommend-btn" onclick="event.stopPropagation(); clearAllDocuments()" style="font-size: 10px; padding: 5px 10px;">Clear All</button>
                    <button class="recommend-btn" id="documents-toggle-btn" style="font-size: 12px; padding: 5px 10px; font-weight: 600;">▼</button>
                </div>
            </div>

            <div id="documents-content" style="overflow: hidden; transition: max-height 0.3s ease-out;">
                <div style="margin-bottom: 12px; padding-top: 8px;">
                    <input type="text" id="documents-search" placeholder="Search documents..." style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 12px; margin-bottom: 10px;" oninput="searchDocuments()">
                </div>

                <div class="upload-area" id="upload-area" onclick="document.getElementById('document-file-input').click()">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Click to upload or drag & drop</div>
                    <div class="upload-hint">PDF, DOC, XLS, Images (Max 5MB per file)</div>
                    <input type="file" id="document-file-input" class="file-input-hidden" onchange="handleDocumentUpload(event)" accept="*/*" multiple>
                </div>

                <div id="documents-list" class="documents-list">
                    <div class="empty-state">No documents yet. Upload one above!</div>
                </div>
            </div>
        </div>

        <!-- Birthday Tracker Section -->
        <div class="birthday-section">
            <div class="birthday-header" onclick="toggleBirthdaySection()" style="cursor: pointer;" title="Click to expand/collapse">
                <h3 class="birthday-title">Birthday Tracker <span id="birthday-count" style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); color: #9f1239; padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0</span></h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="recommend-btn" onclick="event.stopPropagation(); clearAllBirthdays()" style="font-size: 10px; padding: 5px 10px;">Clear All</button>
                    <button class="recommend-btn" id="birthday-toggle-btn" style="font-size: 12px; padding: 5px 10px; font-weight: 600;">▼</button>
                </div>
            </div>

            <div id="birthday-content" style="overflow: hidden; transition: max-height 0.3s ease-out;">
                <div id="birthday-notification" style="display: none;"></div>

                <div class="input-group" style="margin-bottom: 12px; gap: 8px;">
                    <input type="text" id="birthday-name-input" placeholder="Name" style="flex: 1; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                    <input type="date" id="birthday-date-input" placeholder="Birthday" style="flex: 1; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                    <button class="add-btn" onclick="addBirthday()" style="padding: 10px 18px;">Add</button>
                </div>

                <div id="birthdays-list" class="birthday-list">
                    <div class="empty-state">No birthdays yet. Add one above!</div>
                </div>
            </div>
        </div>

        <!-- Reminders Section -->
        <div class="reminders-section">
            <div class="reminders-header" onclick="toggleRemindersSection()" style="cursor: pointer;" title="Click to expand/collapse">
                <h3 class="reminders-title">Reminders <span id="reminders-count" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 6px;">0</span></h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="recommend-btn" onclick="event.stopPropagation(); clearAllReminders()" style="font-size: 10px; padding: 5px 10px;">Clear All</button>
                    <button class="recommend-btn" id="reminders-toggle-btn" style="font-size: 12px; padding: 5px 10px; font-weight: 600;">▼</button>
                </div>
            </div>

            <div id="reminders-content" style="overflow: hidden; transition: max-height 0.3s ease-out;">
                <div id="reminders-notification" style="display: none;"></div>

                <div style="margin-bottom: 12px;">
                    <input type="text" id="reminder-name-input" placeholder="Reminder name (e.g., Netflix Subscription)" style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <select id="reminder-frequency-input" style="padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                            <option value="">Frequency</option>
                            <option value="daily">Daily</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="half-yearly">Half-Yearly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                        <select id="reminder-type-input" style="padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                            <option value="">Type</option>
                            <option value="liability">Liability</option>
                            <option value="investment">Investment</option>
                            <option value="expense">Expense</option>
                        </select>
                        <input type="date" id="reminder-date-input" placeholder="Next Due Date" style="padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
                        <input type="number" id="reminder-amount-input" placeholder="Amount (optional)" step="0.01" min="0" style="padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                        <button class="add-btn" onclick="addReminder()" style="padding: 10px 18px;">Add Reminder</button>
                    </div>
                </div>

                <div id="reminders-list" class="reminders-list">
                    <div class="empty-state">No reminders yet. Add one above!</div>
                </div>
            </div>
        </div>

        <!-- Image Preview Modal -->
        <div id="preview-modal" class="preview-modal" onclick="closePreview()">
            <span class="preview-close" onclick="closePreview()">×</span>
            <img id="preview-image" class="preview-image" src="" alt="Preview" onclick="event.stopPropagation()">
        </div>

        <div class="lists-container">
            <!-- Personal List -->
            <div class="list-section" data-list-type="personal">
                <div class="list-header">
                    <h2>Personal <span id="personal-badge" style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); color: var(--primary-dark); padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600;">0</span></h2>
                    <div>
                        <button class="recommend-btn" onclick="toggleSort('personal')" title="Sort alphabetically" style="margin-right: 5px;">A-Z</button>
                        <button class="recommend-btn" onclick="recommendGoal('personal')">Recommend</button>
                    </div>
                </div>

                <div class="recommendation empty" id="personal-recommendation">
                    <span>Add goals, then click recommend</span>
                </div>

                <div class="input-group">
                    <input type="text" id="personal-input" placeholder="Add goal(s) - paste text/images..." onkeypress="handleKeyPress(event, 'personal')" onpaste="handlePaste(event, 'personal')" oninput="updateCharCount('personal')">
                    <button class="add-btn" onclick="addItem('personal')">Add</button>
                </div>
                <div style="text-align: right; font-size: 10px; color: #999; margin-top: 4px;">
                    <span id="personal-char-count">0 chars</span>
                </div>

                <ul class="checklist" id="personal-list">
                    <li class="empty-state">No goals yet. Add one above!</li>
                </ul>

                <div class="list-footer">
                    <span class="task-counter" id="personal-counter">0 of 0 completed</span>
                    <div>
                        <button class="clear-completed-btn" onclick="clearCompleted('personal')" id="personal-clear">Clear Completed</button>
                        <button class="clear-completed-btn" onclick="clearAll('personal')" style="margin-left: 5px;">Clear All</button>
                    </div>
                </div>
            </div>

            <!-- Professional List -->
            <div class="list-section" data-list-type="professional">
                <div class="list-header">
                    <h2>Professional <span id="professional-badge" style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); color: var(--primary-dark); padding: 3px 9px; border-radius: 10px; font-size: 11px; font-weight: 600;">0</span></h2>
                    <div>
                        <button class="recommend-btn" onclick="toggleSort('professional')" title="Sort alphabetically" style="margin-right: 5px;">A-Z</button>
                        <button class="recommend-btn" onclick="recommendGoal('professional')">Recommend</button>
                    </div>
                </div>

                <div class="recommendation empty" id="professional-recommendation">
                    <span>Add goals, then click recommend</span>
                </div>

                <div class="input-group">
                    <input type="text" id="professional-input" placeholder="Add goal(s) - paste text/images..." onkeypress="handleKeyPress(event, 'professional')" onpaste="handlePaste(event, 'professional')" oninput="updateCharCount('professional')">
                    <button class="add-btn" onclick="addItem('professional')">Add</button>
                </div>
                <div style="text-align: right; font-size: 10px; color: #999; margin-top: 4px;">
                    <span id="professional-char-count">0 chars</span>
                </div>

                <ul class="checklist" id="professional-list">
                    <li class="empty-state">No goals yet. Add one above!</li>
                </ul>

                <div class="list-footer">
                    <span class="task-counter" id="professional-counter">0 of 0 completed</span>
                    <div>
                        <button class="clear-completed-btn" onclick="clearCompleted('professional')" id="professional-clear">Clear Completed</button>
                        <button class="clear-completed-btn" onclick="clearAll('professional')" style="margin-left: 5px;">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid #e8e8e8;">
            <h2 style="margin: 0 0 24px 0; font-size: 22px; font-weight: 600; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Your Progress</h2>
            <div id="stats-content"></div>
            <button onclick="closeStats()" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; margin-top: 24px; width: 100%; font-weight: 500; font-size: 14px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);">Close</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid #e8e8e8;">
            <h2 style="margin: 0 0 24px 0; font-size: 22px; font-weight: 600; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Keyboard Shortcuts</h2>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <span style="font-size: 13px; color: #666;">Undo last action</span>
                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid #e0e0e0; font-size: 12px; font-weight: 500;">Ctrl+Z</kbd>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <span style="font-size: 13px; color: #666;">Add goal (in input)</span>
                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid #e0e0e0; font-size: 12px; font-weight: 500;">Enter</kbd>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <span style="font-size: 13px; color: #666;">Cancel edit</span>
                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid #e0e0e0; font-size: 12px; font-weight: 500;">Escape</kbd>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <span style="font-size: 13px; color: #666;">Edit goal</span>
                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid #e0e0e0; font-size: 12px; font-weight: 500;">Double-click</kbd>
                </div>
            </div>
            <button onclick="closeHelp()" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; margin-top: 24px; width: 100%; font-weight: 500; font-size: 14px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);">Close</button>
        </div>
    </div>

    <!-- Password Protection Script -->
    <script>
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Password protection
        const CORRECT_PASSWORD = '5020';
        const PASSWORD_SESSION_KEY = 'gitesh_tracker_authenticated';

        // Check if already authenticated in this session
        function checkAuthStatus() {
            const isAuthenticated = sessionStorage.getItem(PASSWORD_SESSION_KEY);
            if (isAuthenticated === 'true') {
                unlockApp();
            } else {
                // Focus on password input
                setTimeout(() => {
                    document.getElementById('password-input').focus();
                }, 100);
            }
        }

        // Check password
        function checkPassword() {
            const input = document.getElementById('password-input');
            const errorDiv = document.getElementById('password-error');

            if (input.value === CORRECT_PASSWORD) {
                sessionStorage.setItem(PASSWORD_SESSION_KEY, 'true');
                unlockApp();
            } else {
                errorDiv.style.display = 'block';
                input.value = '';
                input.focus();

                // Hide error after 3 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Unlock the app
        function unlockApp() {
            document.getElementById('password-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }

        // Handle Enter key in password input
        function handlePasswordKeyPress(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        }

        // Check authentication status on page load
        checkAuthStatus();
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        // Disable browser scroll restoration and force scroll to top on page load/refresh
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }
        window.scrollTo(0, 0);

        try {
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const { getFirestore, doc, setDoc, getDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const { getStorage, ref, uploadString, getDownloadURL, deleteObject } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js');

            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCZcEWiJSDKkwVCgDeFfdoI1z3_Bc3FxEE",
                authDomain: "gitesh-checklist.firebaseapp.com",
                projectId: "gitesh-checklist",
                storageBucket: "gitesh-checklist.firebasestorage.app",
                messagingSenderId: "867346897634",
                appId: "1:867346897634:web:6c6bdaa2e42cc2190b5cbb",
                measurementId: "G-3TFN5FZZMH"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const storage = getStorage(app);

            // Make Firebase available globally
            window.db = db;
            window.storage = storage;
            window.firestoreDoc = doc;
            window.firestoreSetDoc = setDoc;
            window.firestoreGetDoc = getDoc;
            window.firestoreOnSnapshot = onSnapshot;
            window.storageRef = ref;
            window.storageUploadString = uploadString;
            window.storageGetDownloadURL = getDownloadURL;
            window.storageDeleteObject = deleteObject;
            window.firebaseReady = true;

            // Trigger load once Firebase is ready
            if (window.onFirebaseReady) window.onFirebaseReady();
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            window.firebaseReady = false;

            // Update status to show offline mode
            const statusEl = document.getElementById('sync-status');
            if (statusEl) {
                statusEl.className = 'sync-status offline';
                statusEl.textContent = 'Local Mode Only';
            }
        }
    </script>

    <script>
        // ONE DATABASE FOR ALL DEVICES - Personal app for Gitesh
        function getUserId() {
            // FIXED ID - same on ALL devices (mobile, desktop, any browser)
            // This ensures ONE database with same data everywhere
            return 'GITESH_MAIN_DB';
        }

        function setSyncId(newId) {
            if (!newId || newId.length < 4) {
                alert('Sync ID must be at least 4 characters');
                return false;
            }
            localStorage.setItem('userId', newId.toUpperCase());
            alert('Sync ID updated! Please reload the page to sync with new ID.');
            return true;
        }

        function showSyncId() {
            const currentId = getUserId();
            const change = confirm(
                `🔄 YOUR SYNC CODE: ${currentId}\n\n` +
                `📱 MOBILE: Enter "${currentId}"\n` +
                `💻 DESKTOP: Enter "${currentId}"\n\n` +
                `Same code = Same data on all devices!\n\n` +
                `━━━━━━━━━━━━━━━━━━━━━━\n\n` +
                `Click OK to CHANGE your sync code\n` +
                `Click CANCEL to keep it`
            );

            if (change) {
                const newId = prompt(
                    `Enter NEW sync code (4+ characters):\n\n` +
                    `Current: ${currentId}\n\n` +
                    `⚠️ Warning: Changing this will point to\n` +
                    `different data in the cloud!`,
                    currentId
                );

                if (newId && newId.trim().length >= 4 && newId !== currentId) {
                    localStorage.setItem('userId', newId.trim().toUpperCase());
                    alert(`✅ Sync code changed to: ${newId.trim().toUpperCase()}\n\nReloading app...`);
                    location.reload();
                }
            }
        }

        function updateSyncIdDisplay() {
            const displayEl = document.getElementById('sync-id-display');
            if (displayEl) {
                displayEl.textContent = getUserId();
            }
        }

        // Debug function to check sync status
        async function showSyncDebug() {
            const personal = personalGoals.length;
            const professional = professionalGoals.length;
            const total = personal + professional;
            const localPersonal = JSON.parse(localStorage.getItem('personalGoals') || '[]').length;
            const localProfessional = JSON.parse(localStorage.getItem('professionalGoals') || '[]').length;

            // Try to fetch cloud data
            let cloudTotal = 'Loading...';
            let cloudPersonal = '?';
            let cloudProfessional = '?';

            if (window.firebaseReady && window.db) {
                try {
                    const docRef = window.firestoreDoc(window.db, 'goals', getCloudDocId());
                    const docSnap = await window.firestoreGetDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        cloudPersonal = (data.personal || []).length;
                        cloudProfessional = (data.professional || []).length;
                        cloudTotal = cloudPersonal + cloudProfessional;
                    } else {
                        cloudTotal = 'No cloud data';
                    }
                } catch (error) {
                    cloudTotal = 'Error: ' + error.message;
                }
            } else {
                cloudTotal = 'Firebase not ready';
            }

            const debug = `🔍 SYNC DEBUG INFO\n\n` +
                `📱 Current Device:\n` +
                `Sync ID: ${getUserId()}\n` +
                `Cloud Doc ID: ${getCloudDocId()}\n\n` +
                `📊 Goals Count:\n` +
                `In Memory: ${total} (${personal}P + ${professional}P)\n` +
                `In LocalStorage: ${localPersonal + localProfessional} (${localPersonal}P + ${localProfessional}P)\n` +
                `☁️ In Cloud: ${cloudTotal} (${cloudPersonal}P + ${cloudProfessional}P)\n\n` +
                `🔥 Firebase Status:\n` +
                `Firebase Ready: ${window.firebaseReady ? '✅ YES' : '❌ NO'}\n` +
                `Firebase DB: ${window.db ? '✅ Connected' : '❌ Not Connected'}\n` +
                `Online: ${navigator.onLine ? '✅ YES' : '❌ NO'}\n\n` +
                `❗ MISMATCH DETECTED!\n` +
                `Your devices have DIFFERENT Sync IDs!\n\n` +
                `💡 TO FIX:\n` +
                `1. Open BOTH devices side-by-side\n` +
                `2. Pick ONE Sync ID to use\n` +
                `3. Click "Sync ID" button on BOTH devices\n` +
                `4. Enter the SAME ID on both\n` +
                `5. Click "Force Sync" button below`;

            alert(debug);
        }

        // Force sync function - gives user choice
        async function forceSync() {
            if (!window.firebaseReady || !window.db) {
                alert('Firebase not ready. Please refresh the page.');
                return;
            }

            const choice = confirm(
                `🔄 FORCE SYNC\n\n` +
                `Current device has ${personalGoals.length + professionalGoals.length} goals.\n\n` +
                `Click OK to:\n` +
                `✅ UPLOAD local data to cloud (overwrite cloud)\n\n` +
                `Click CANCEL to:\n` +
                `⬇️ DOWNLOAD cloud data (overwrite local)`
            );

            if (choice) {
                // Upload to cloud
                console.log('🚀 FORCE UPLOAD - Uploading local data to cloud...');
                await saveToCloud();
                alert('✅ Local data uploaded to cloud!\n\nNow open other device and click Force Sync → CANCEL to download.');
            } else {
                // Download from cloud
                console.log('⬇️ FORCE DOWNLOAD - Downloading cloud data...');
                const docRef = window.firestoreDoc(window.db, 'goals', getCloudDocId());
                const docSnap = await window.firestoreGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    personalGoals = data.personal || [];
                    professionalGoals = data.professional || [];

                    localStorage.setItem('personalGoals', JSON.stringify(personalGoals));
                    localStorage.setItem('professionalGoals', JSON.stringify(professionalGoals));

                    renderList('personal');
                    renderList('professional');
                    updatePageTitle();
                    renderDashboard();

                    alert(`✅ Downloaded ${personalGoals.length + professionalGoals.length} goals from cloud!\n\nNow both devices should show same data.`);
                } else {
                    alert('❌ No cloud data found. Upload from other device first.');
                }
            }
        }

        // Get current cloud doc ID (dynamic, always reads latest from localStorage)
        function getCloudDocId() {
            return getUserId();
        }

        // RESET EVERYTHING - Clear all data and start fresh
        async function resetEverything() {
            const confirm1 = confirm(
                '⚠️ RESET EVERYTHING?\n\n' +
                'This will DELETE:\n' +
                '• All goals (personal & professional)\n' +
                '• All habits\n' +
                '• All notes\n' +
                '• All weight data\n' +
                '• Cloud database\n\n' +
                'This CANNOT be undone!\n\n' +
                'Click OK to continue, CANCEL to abort.'
            );

            if (!confirm1) return;

            const confirm2 = confirm(
                '⚠️ FINAL WARNING!\n\n' +
                'Are you ABSOLUTELY SURE?\n\n' +
                'All your data will be permanently deleted!'
            );

            if (!confirm2) return;

            try {
                console.log('🗑️ NUCLEAR RESET STARTING...');

                // 1. Unsubscribe from real-time listener FIRST
                if (goalsUnsubscribe) {
                    console.log('🔌 Unsubscribing listener...');
                    goalsUnsubscribe();
                    goalsUnsubscribe = null;
                }

                // 2. Clear in-memory data
                personalGoals = [];
                professionalGoals = [];
                console.log('💾 Memory cleared');

                // 3. Clear ALL browser storage
                localStorage.clear();
                sessionStorage.clear();
                console.log('🧹 Storage cleared');

                // 4. Clear Firebase completely
                if (window.firebaseReady && window.db) {
                    const cloudDocId = getCloudDocId();
                    console.log(`☁️ Clearing Firebase: ${cloudDocId}`);

                    await window.firestoreSetDoc(
                        window.firestoreDoc(window.db, 'goals', cloudDocId),
                        { personal: [], professional: [], lastUpdated: new Date().toISOString() }
                    );

                    await window.firestoreSetDoc(
                        window.firestoreDoc(window.db, 'habits', cloudDocId),
                        { habits: {}, lastUpdated: new Date().toISOString() }
                    );

                    await window.firestoreSetDoc(
                        window.firestoreDoc(window.db, 'notes', cloudDocId),
                        { notes: [], lastUpdated: new Date().toISOString() }
                    );

                    await window.firestoreSetDoc(
                        window.firestoreDoc(window.db, 'weight', cloudDocId),
                        { weightData: [], lastUpdated: new Date().toISOString() }
                    );

                    console.log('✅ Firebase cleared!');

                    // Wait for Firebase to sync
                    await new Promise(r => setTimeout(r, 1500));
                }

                alert('✅ NUCLEAR RESET COMPLETE!\n\nEverything deleted from:\n• Memory\n• Local Storage\n• Firebase Cloud\n\nReloading...');

                // Hard reload after delay
                setTimeout(() => location.reload(true), 1000);

            } catch (error) {
                console.error('❌ Reset failed:', error);
                alert('❌ RESET FAILED!\n\n' + error.message + '\n\nCheck console (F12)');
            }
        }

        // DIAGNOSTIC: Check what's actually in Firebase
        async function checkFirebaseData() {
            if (!window.firebaseReady || !window.db) {
                alert('❌ Firebase not ready!');
                return;
            }

            try {
                const cloudDocId = getCloudDocId();
                const docRef = window.firestoreDoc(window.db, 'goals', cloudDocId);
                const docSnap = await window.firestoreGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudPersonal = (data.personal || []).length;
                    const cloudProfessional = (data.professional || []).length;
                    const cloudTotal = cloudPersonal + cloudProfessional;

                    const localPersonal = personalGoals.length;
                    const localProfessional = professionalGoals.length;
                    const localTotal = localPersonal + localProfessional;

                    const localStoragePersonal = JSON.parse(localStorage.getItem('personalGoals') || '[]').length;
                    const localStorageProfessional = JSON.parse(localStorage.getItem('professionalGoals') || '[]').length;
                    const localStorageTotal = localStoragePersonal + localStorageProfessional;

                    alert(
                        `🔍 DATA DIAGNOSTIC\n\n` +
                        `Sync ID: ${cloudDocId}\n\n` +
                        `☁️ FIREBASE CLOUD:\n` +
                        `   Total: ${cloudTotal} goals\n` +
                        `   Personal: ${cloudPersonal}\n` +
                        `   Professional: ${cloudProfessional}\n\n` +
                        `💾 IN-MEMORY (Current):\n` +
                        `   Total: ${localTotal} goals\n` +
                        `   Personal: ${localPersonal}\n` +
                        `   Professional: ${localProfessional}\n\n` +
                        `💿 LOCAL STORAGE:\n` +
                        `   Total: ${localStorageTotal} goals\n` +
                        `   Personal: ${localStoragePersonal}\n` +
                        `   Professional: ${localStorageProfessional}\n\n` +
                        `Last Updated: ${data.lastUpdated || 'Unknown'}`
                    );
                } else {
                    alert(`❌ No Firebase data found for Sync ID: ${cloudDocId}`);
                }
            } catch (error) {
                alert(`❌ Error checking Firebase:\n${error.message}`);
                console.error(error);
            }
        }

        // Clean up duplicates from current data and Firebase
        async function cleanupDuplicates() {
            const beforePersonal = personalGoals.length;
            const beforeProfessional = professionalGoals.length;
            const beforeTotal = beforePersonal + beforeProfessional;

            // Deduplicate in-memory data
            personalGoals = deduplicateGoals(personalGoals);
            professionalGoals = deduplicateGoals(professionalGoals);

            const afterPersonal = personalGoals.length;
            const afterProfessional = professionalGoals.length;
            const afterTotal = afterPersonal + afterProfessional;
            const removed = beforeTotal - afterTotal;

            // Save cleaned data
            localStorage.setItem('personalGoals', JSON.stringify(personalGoals));
            localStorage.setItem('professionalGoals', JSON.stringify(professionalGoals));

            // Save to cloud
            if (window.firebaseReady && window.db) {
                await saveToCloud();
            }

            // Re-render
            renderList('personal');
            renderList('professional');
            updatePageTitle();
            renderDashboard();

            alert(`🧹 CLEANUP COMPLETE!\n\nBefore: ${beforeTotal} goals (${beforePersonal}P + ${beforeProfessional}P)\nAfter: ${afterTotal} goals (${afterPersonal}P + ${afterProfessional}P)\n\nRemoved ${removed} duplicates!`);
        }

        let goalsUnsubscribe = null; // Store listener unsubscribe function
        let isLoadingFromCloud = false;
        let isSavingToCloud = false; // Flag to prevent listener overwrite during save
        let isOnline = navigator.onLine;

        // Load data from localStorage first (fallback)
        let personalGoals = JSON.parse(localStorage.getItem('personalGoals')) || [];
        let professionalGoals = JSON.parse(localStorage.getItem('professionalGoals')) || [];
        let idCounter = Date.now();

        // Deduplicate on load to fix any existing duplicates
        personalGoals = deduplicateGoals(personalGoals);
        professionalGoals = deduplicateGoals(professionalGoals);

        // Generate unique ID with collision prevention
        function generateId() {
            return idCounter++ + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Convert URLs to clickable hyperlinks
        function linkifyText(text) {
            // Escape HTML first
            const escaped = escapeHtml(text);

            // URL regex pattern
            const urlPattern = /(https?:\/\/[^\s]+)/g;

            // Replace URLs with clickable links
            return escaped.replace(urlPattern, function(url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: underline; cursor: pointer;" onclick="event.stopPropagation()">${url}</a>`;
            });
        }

        // Update page title with goal count
        function updatePageTitle() {
            const total = personalGoals.length + professionalGoals.length;
            const completed = personalGoals.filter(g => g.completed).length + professionalGoals.filter(g => g.completed).length;

            // Get today's habits
            const today = getTodayDate();
            const todayHabits = dailyHabits[today] || {};
            const completedHabits = HABITS.filter(h => todayHabits[h] === true).length;

            if (total > 0 || completedHabits > 0) {
                document.title = `(${completed}/${total} goals, ${completedHabits}/9 habits) Gitesh`;
            } else {
                document.title = 'Gitesh Life Tracker';
            }
        }

        // Update character count for input
        function updateCharCount(type) {
            const input = document.getElementById(`${type}-input`);
            const counter = document.getElementById(`${type}-char-count`);
            if (input && counter) {
                const length = input.value.length;
                counter.textContent = `${length} chars`;
                counter.style.color = '#999';
                counter.style.fontWeight = 'normal';
            }
        }

        // Show completion celebration animation
        function showCompletionAnimation() {
            // Create celebration element
            const celebration = document.createElement('div');
            celebration.innerHTML = '🎉';
            celebration.style.position = 'fixed';
            celebration.style.top = '50%';
            celebration.style.left = '50%';
            celebration.style.transform = 'translate(-50%, -50%) scale(0)';
            celebration.style.fontSize = '80px';
            celebration.style.zIndex = '10000';
            celebration.style.pointerEvents = 'none';
            celebration.style.transition = 'all 0.6s ease-out';
            document.body.appendChild(celebration);

            // Animate in
            setTimeout(() => {
                celebration.style.transform = 'translate(-50%, -50%) scale(1.5)';
                celebration.style.opacity = '0';
            }, 10);

            // Remove after animation
            setTimeout(() => {
                document.body.removeChild(celebration);
            }, 650);
        }

        // Search/filter state
        let searchTerm = '';

        // Sort state (load from localStorage or default to false)
        let sortAlphabetically = JSON.parse(localStorage.getItem('sortAlphabetically')) || { personal: false, professional: false };

        // Filter state (all, active, completed) (load from localStorage or default to 'all')
        let filterState = JSON.parse(localStorage.getItem('filterState')) || { personal: 'all', professional: 'all' };

        // Undo state
        let undoStack = [];

        function saveUndoState() {
            undoStack.push({
                personal: JSON.parse(JSON.stringify(personalGoals)),
                professional: JSON.parse(JSON.stringify(professionalGoals))
            });
            if (undoStack.length > 10) undoStack.shift(); // Keep only last 10 states
            updateUndoButton();
        }

        function undo() {
            if (undoStack.length === 0) {
                alert('Nothing to undo');
                return;
            }
            const prevState = undoStack.pop();
            personalGoals = deduplicateGoals(prevState.personal);
            professionalGoals = deduplicateGoals(prevState.professional);
            saveData('personal');
            saveData('professional');
            renderList('personal');
            renderList('professional');
            updatePageTitle();
            updateUndoButton();
        }

        function updateUndoButton() {
            // Update undo button visual state
            const undoButtons = document.querySelectorAll('[onclick="undo()"]');
            undoButtons.forEach(btn => {
                if (undoStack.length === 0) {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }

        function toggleSort(type) {
            sortAlphabetically[type] = !sortAlphabetically[type];
            localStorage.setItem('sortAlphabetically', JSON.stringify(sortAlphabetically));
            renderList(type);
        }

        function updateFilterButtons(type) {
            const currentFilter = filterState[type];
            ['all', 'active', 'completed'].forEach(f => {
                const btn = document.getElementById(`${type}-filter-${f}`);
                if (btn) {
                    if (f === currentFilter) {
                        btn.style.background = 'var(--primary)';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = '#fff';
                        btn.style.color = '#666';
                    }
                }
            });
        }

        function setFilter(type, filter) {
            filterState[type] = filter;
            localStorage.setItem('filterState', JSON.stringify(filterState));
            updateFilterButtons(type);
            renderList(type);
        }

        // Prefer cloud over local to prevent duplicates (cloud is source of truth)
        function mergeGoals(local, cloud) {
            // If cloud has data, use cloud as source of truth
            if (cloud.length > 0) {
                console.log(`☁️ Using cloud data (${cloud.length} goals) as source of truth`);
                return cloud;
            }

            // If cloud is empty but local has data, upload local to cloud
            if (local.length > 0) {
                console.log(`📤 Cloud empty, using local data (${local.length} goals)`);
                return local;
            }

            // Both empty
            return [];
        }

        // Deduplicate goals array by ID AND text (keep first occurrence)
        function deduplicateGoals(goals) {
            const seenIds = new Set();
            const seenTexts = new Set();
            return goals.filter(goal => {
                const normalizedText = goal.text.toLowerCase().trim();

                // Check if we've seen this ID or text before
                if (seenIds.has(goal.id) || seenTexts.has(normalizedText)) {
                    console.log(`🗑️ Removing duplicate: "${goal.text}"`);
                    return false;
                }

                seenIds.add(goal.id);
                seenTexts.add(normalizedText);
                return true;
            });
        }

        // Merge habits from two sources
        function mergeHabits(local, cloud) {
            const merged = {...cloud};

            // Merge each date's habits
            Object.keys(local).forEach(date => {
                if (!merged[date]) {
                    merged[date] = local[date];
                } else {
                    // Merge habits for this date (prefer local if conflict)
                    merged[date] = {...merged[date], ...local[date]};
                }
            });

            return merged;
        }

        // Merge notes from two sources (prefer cloud)
        function mergeNotes(local, cloud) {
            // Prefer cloud as source of truth
            if (cloud.length > 0) {
                console.log(`☁️ Using cloud notes (${cloud.length}) as source of truth`);
                return cloud;
            }
            if (local.length > 0) {
                console.log(`📤 Cloud empty, using local notes (${local.length})`);
                return local;
            }
            return [];
        }

        // Merge weight data from two sources (prefer cloud)
        function mergeWeightData(local, cloud) {
            // Prefer cloud as source of truth
            if (cloud.length > 0) {
                console.log(`☁️ Using cloud weight data (${cloud.length}) as source of truth`);
                return cloud;
            }
            if (local.length > 0) {
                console.log(`📤 Cloud empty, using local weight data (${local.length})`);
                return local;
            }
            return [];
        }

        // Cloud sync functions
        async function loadFromCloud() {
            if (!window.firebaseReady || !window.db) {
                console.log('Firebase not ready yet');
                return;
            }

            try {
                const currentDocId = getCloudDocId();
                const docRef = window.firestoreDoc(window.db, 'goals', currentDocId);
                const docSnap = await window.firestoreGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isLoadingFromCloud = true;

                    // Load images from chunks and reconstruct
                    const cloudPersonalWithImages = await loadAttachmentsFromCloud(data.personal || []);
                    const cloudProfessionalWithImages = await loadAttachmentsFromCloud(data.professional || []);

                    // MERGE instead of overwrite to prevent data loss
                    const cloudPersonal = deduplicateGoals(cloudPersonalWithImages);
                    const cloudProfessional = deduplicateGoals(cloudProfessionalWithImages);

                    personalGoals = deduplicateGoals(mergeGoals(personalGoals, cloudPersonal));
                    professionalGoals = deduplicateGoals(mergeGoals(professionalGoals, cloudProfessional));

                    // Save merged and deduplicated data back to cloud
                    await saveToCloud();

                    // Also save to localStorage as backup
                    localStorage.setItem('personalGoals', JSON.stringify(personalGoals));
                    localStorage.setItem('professionalGoals', JSON.stringify(professionalGoals));

                    renderList('personal');
                    renderList('professional');
                    updatePageTitle();
                    isLoadingFromCloud = false;
                    console.log('✅ Loaded and merged from cloud');
                } else {
                    // No cloud data, upload current local data
                    await saveToCloud();
                }

                // Unsubscribe from old listener before creating new one
                if (goalsUnsubscribe) {
                    console.log('🔌 Unsubscribing from old listener');
                    goalsUnsubscribe();
                    goalsUnsubscribe = null;
                }

                // Listen for real-time updates (store unsubscribe function)
                console.log(`👂 Setting up real-time listener for doc: ${currentDocId}`);
                goalsUnsubscribe = window.firestoreOnSnapshot(docRef, async (doc) => {
                    console.log(`🔔 Listener triggered - isLoadingFromCloud: ${isLoadingFromCloud}, isSavingToCloud: ${isSavingToCloud}`);

                    if (doc.exists() && !isLoadingFromCloud && !isSavingToCloud) {
                        const data = doc.data();

                        // Load images from chunks
                        const cloudPersonalWithImages = await loadAttachmentsFromCloud(data.personal || []);
                        const cloudProfessionalWithImages = await loadAttachmentsFromCloud(data.professional || []);

                        const cloudPersonal = deduplicateGoals(cloudPersonalWithImages);
                        const cloudProfessional = deduplicateGoals(cloudProfessionalWithImages);

                        console.log(`🔄 Listener UPDATING LOCAL DATA - Received ${cloudPersonal.length}P + ${cloudProfessional.length}P = ${cloudPersonal.length + cloudProfessional.length} goals from cloud`);
                        console.log(`🔄 Current local: ${personalGoals.length}P + ${professionalGoals.length}P`);

                        // Directly use cloud data (now includes images from chunks)
                        personalGoals = cloudPersonal;
                        professionalGoals = cloudProfessional;

                        // Save to localStorage for offline access
                        localStorage.setItem('personalGoals', JSON.stringify(personalGoals));
                        localStorage.setItem('professionalGoals', JSON.stringify(professionalGoals));

                        renderList('personal');
                        renderList('professional');
                        updatePageTitle();
                        renderDashboard();
                        console.log('✅ UI updated with cloud data');
                    }
                });
            } catch (error) {
                console.error('Error loading from cloud:', error);
            }
        }

        // Store image in separate Firestore chunks to bypass 1MB limit
        async function uploadImageToChunks(base64Data, attachmentId) {
            if (!window.db) return null;

            try {
                const userId = getUserId();
                const CHUNK_SIZE = 800000; // 800KB per chunk to stay well under 1MB

                // Split base64 data into chunks
                const chunks = [];
                for (let i = 0; i < base64Data.length; i += CHUNK_SIZE) {
                    chunks.push(base64Data.substring(i, i + CHUNK_SIZE));
                }

                console.log(`📦 Splitting image ${attachmentId} into ${chunks.length} chunks`);

                // Save each chunk to Firestore
                for (let i = 0; i < chunks.length; i++) {
                    const chunkDocRef = window.firestoreDoc(window.db, 'image-chunks', `${userId}_${attachmentId}_chunk${i}`);
                    await window.firestoreSetDoc(chunkDocRef, {
                        chunk: chunks[i],
                        chunkIndex: i,
                        totalChunks: chunks.length,
                        attachmentId: attachmentId,
                        userId: userId,
                        createdAt: new Date().toISOString()
                    });
                }

                console.log(`☁️ Uploaded ${chunks.length} chunks for image: ${attachmentId}`);
                return { chunked: true, totalChunks: chunks.length };
            } catch (error) {
                console.error('Error uploading image chunks:', error);
                return null;
            }
        }

        // Load image from Firestore chunks
        async function loadImageFromChunks(attachmentId, totalChunks) {
            if (!window.db) return null;

            try {
                const userId = getUserId();
                const chunks = [];

                // Load all chunks
                for (let i = 0; i < totalChunks; i++) {
                    const chunkDocRef = window.firestoreDoc(window.db, 'image-chunks', `${userId}_${attachmentId}_chunk${i}`);
                    const chunkDoc = await window.firestoreGetDoc(chunkDocRef);

                    if (chunkDoc.exists()) {
                        chunks.push(chunkDoc.data().chunk);
                    } else {
                        console.error(`Missing chunk ${i} for image ${attachmentId}`);
                        return null;
                    }
                }

                // Reassemble the full base64 string
                const fullData = chunks.join('');
                console.log(`📦 Reassembled image ${attachmentId} from ${chunks.length} chunks`);
                return fullData;
            } catch (error) {
                console.error('Error loading image chunks:', error);
                return null;
            }
        }

        // Delete image chunks from Firestore
        async function deleteImageChunks(attachmentId, totalChunks) {
            if (!window.db) return;

            try {
                const userId = getUserId();
                for (let i = 0; i < totalChunks; i++) {
                    const chunkDocRef = window.firestoreDoc(window.db, 'image-chunks', `${userId}_${attachmentId}_chunk${i}`);
                    await window.firestoreDeleteDoc(chunkDocRef);
                }
                console.log(`🗑️ Deleted ${totalChunks} chunks for image: ${attachmentId}`);
            } catch (error) {
                console.error('Error deleting image chunks:', error);
            }
        }

        // Process attachments for cloud storage (upload images as chunks)
        async function processAttachmentsForCloud(goals) {
            const processedGoals = [];

            for (const goal of goals) {
                const goalCopy = { ...goal };

                if (goal.attachments && goal.attachments.length > 0) {
                    const processedAttachments = [];

                    for (const att of goal.attachments) {
                        if (att.type === 'img' && att.data && att.data.startsWith('data:')) {
                            // New image with base64 data - upload as chunks
                            const chunkInfo = await uploadImageToChunks(att.data, att.id);

                            if (chunkInfo) {
                                // Store reference to chunks instead of data
                                processedAttachments.push({
                                    id: att.id,
                                    type: att.type,
                                    chunked: true,
                                    totalChunks: chunkInfo.totalChunks
                                });
                            } else {
                                // Upload failed, skip this image
                                console.error(`Failed to upload image ${att.id}`);
                            }
                        } else if (att.chunked) {
                            // Already chunked, keep the reference
                            processedAttachments.push({
                                id: att.id,
                                type: att.type,
                                chunked: true,
                                totalChunks: att.totalChunks
                            });
                        } else {
                            // Other file types, keep as-is
                            processedAttachments.push(att);
                        }
                    }

                    goalCopy.attachments = processedAttachments;
                } else {
                    goalCopy.attachments = [];
                }

                processedGoals.push(goalCopy);
            }

            return processedGoals;
        }

        // Load attachments from cloud (reconstruct images from chunks)
        async function loadAttachmentsFromCloud(goals) {
            const goalsWithData = [];

            for (const goal of goals) {
                const goalCopy = { ...goal };

                if (goal.attachments && goal.attachments.length > 0) {
                    const attachmentsWithData = [];

                    for (const att of goal.attachments) {
                        if (att.chunked && att.totalChunks) {
                            // Load image from chunks
                            const data = await loadImageFromChunks(att.id, att.totalChunks);

                            if (data) {
                                attachmentsWithData.push({
                                    id: att.id,
                                    type: att.type,
                                    data: data,
                                    chunked: true,
                                    totalChunks: att.totalChunks
                                });
                            } else {
                                console.error(`Failed to load image ${att.id}`);
                            }
                        } else {
                            // Not chunked, keep as-is
                            attachmentsWithData.push(att);
                        }
                    }

                    goalCopy.attachments = attachmentsWithData;
                } else {
                    goalCopy.attachments = [];
                }

                goalsWithData.push(goalCopy);
            }

            return goalsWithData;
        }

        async function saveToCloud() {
            if (!window.firebaseReady || !window.db) {
                // Clear flag if Firebase not ready
                setTimeout(() => {
                    isSavingToCloud = false;
                }, 100);
                return;
            }

            try {
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.className = 'sync-status syncing';
                    statusEl.textContent = 'Syncing...';
                }

                // Deduplicate before saving to ensure clean data in cloud
                personalGoals = deduplicateGoals(personalGoals);
                professionalGoals = deduplicateGoals(professionalGoals);

                // Process images as chunks (avoids 1MB Firestore limit)
                console.log(`☁️ Starting cloud save - ${personalGoals.length}P + ${professionalGoals.length}P goals`);
                const personalForCloud = await processAttachmentsForCloud(personalGoals);
                const professionalForCloud = await processAttachmentsForCloud(professionalGoals);
                console.log('☁️ Images chunked, saving to Firestore...');

                const docRef = window.firestoreDoc(window.db, 'goals', getCloudDocId());
                await window.firestoreSetDoc(docRef, {
                    personal: personalForCloud,
                    professional: professionalForCloud,
                    lastUpdated: new Date().toISOString()
                });

                if (statusEl) {
                    statusEl.className = 'sync-status synced';
                    statusEl.textContent = 'Cloud Synced';
                }
                console.log(`✅ CLOUD SAVE COMPLETE [Doc: ${getCloudDocId()}] - ${personalForCloud.length}P + ${professionalForCloud.length}P = ${personalForCloud.length + professionalForCloud.length} total goals`);

                // Clear flag after a longer delay to ensure listener doesn't fire too soon
                setTimeout(() => {
                    isSavingToCloud = false;
                    console.log('✅ isSavingToCloud flag cleared - listener can now update');
                }, 2000);
            } catch (error) {
                console.error('Error saving to cloud:', error);
                isSavingToCloud = false; // Clear flag on error

                // Check if it's a document size error
                if (error.message && error.message.includes('exceeds the maximum allowed size')) {
                    alert('⚠️ Data too large for cloud sync!\n\nYour data (including images) exceeds Firestore\'s 1MB limit.\n\nSuggestions:\n• Delete some old items or images\n• Use smaller images\n• Your data is still saved locally');
                }

                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.className = 'sync-status error';
                    statusEl.textContent = 'Sync Error';
                }
            }
        }

        // Manual sync function
        async function manualSync() {
            if (!navigator.onLine) {
                alert('You are offline. Please check your internet connection.');
                return;
            }
            if (!window.firebaseReady) {
                alert('Firebase not initialized. Please refresh the page.');
                return;
            }

            const statusEl = document.getElementById('sync-status');
            if (statusEl) {
                statusEl.className = 'sync-status syncing';
                statusEl.textContent = 'Syncing...';
            }

            try {
                await loadFromCloud();
                if (statusEl) {
                    statusEl.className = 'sync-status synced';
                    statusEl.textContent = 'Synced!';
                }
                setTimeout(() => {
                    if (statusEl) {
                        statusEl.className = 'sync-status synced';
                        statusEl.textContent = 'Cloud Synced';
                    }
                }, 2000);
            } catch (error) {
                if (statusEl) {
                    statusEl.className = 'sync-status error';
                    statusEl.textContent = 'Sync Failed';
                }
                alert('Sync failed. Please try again.');
            }
        }

        // Online/Offline detection
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusEl = document.getElementById('sync-status');
            if (!statusEl) return;

            if (!isOnline) {
                statusEl.className = 'sync-status offline';
                statusEl.textContent = 'Offline Mode';
            } else if (window.firebaseReady) {
                statusEl.className = 'sync-status synced';
                statusEl.textContent = 'Cloud Synced';
            }
        }

        // Render Dashboard Summary
        function renderDashboard() {
            // 1. Active Goals Count
            const totalGoals = personalGoals.length + professionalGoals.length;
            const activeGoals = personalGoals.filter(g => !g.completed).length + professionalGoals.filter(g => !g.completed).length;
            const completedGoals = personalGoals.filter(g => g.completed).length + professionalGoals.filter(g => g.completed).length;

            document.getElementById('dashboard-goals-count').textContent = activeGoals;

            let goalsSubtitle = '';
            if (totalGoals === 0) {
                goalsSubtitle = 'No goals yet';
            } else {
                goalsSubtitle = `${completedGoals} completed`;
                if (activeGoals > 0) {
                    goalsSubtitle += ` • ${activeGoals} active`;
                }
            }
            document.getElementById('dashboard-goals-subtitle').innerHTML = goalsSubtitle;

            // 2. Today's Habits Completion
            const today = getTodayDate();
            const todayHabits = dailyHabits[today] || {};
            const completedHabitsCount = HABITS.filter(h => todayHabits[h] === true).length;
            const totalHabits = HABITS.length;
            const habitsPercent = totalHabits > 0 ? Math.round((completedHabitsCount / totalHabits) * 100) : 0;

            document.getElementById('dashboard-habits-percent').textContent = habitsPercent + '%';
            document.getElementById('dashboard-habits-subtitle').textContent = `${completedHabitsCount}/${totalHabits} completed`;

            // 3. Best Habit Streak
            let bestStreak = 0;
            let bestStreakHabit = '';

            HABITS.forEach(habitName => {
                const streak = calculateStreak(habitName);
                if (streak > bestStreak) {
                    bestStreak = streak;
                    bestStreakHabit = habitName;
                }
            });

            document.getElementById('dashboard-best-streak').textContent = bestStreak;

            if (bestStreak > 0) {
                const habitDisplayNames = {
                    'icefacial': 'Ice Facial',
                    'workout': '10K Steps',
                    'temple': 'Temple Visit',
                    'meditation': 'Meditation',
                    'noBadHabits': 'No Smoking',
                    'learning': 'Learning',
                    'protein': 'No Fap/Porn',
                    'posture': 'Posture',
                    'sleep': 'Sleep'
                };
                document.getElementById('dashboard-streak-subtitle').textContent = habitDisplayNames[bestStreakHabit] || bestStreakHabit;
            } else {
                document.getElementById('dashboard-streak-subtitle').textContent = 'No active streaks';
            }

            // 4. Weight Progress
            if (weightData && weightData.length > 0) {
                const sortedWeight = [...weightData].sort((a, b) => new Date(a.date) - new Date(b.date));
                const latestEntry = sortedWeight[sortedWeight.length - 1];
                const startEntry = sortedWeight[0];

                const currentWeight = latestEntry.weight;
                const totalChange = currentWeight - startEntry.weight;

                document.getElementById('dashboard-weight-value').textContent = currentWeight.toFixed(1) + ' kg';

                let weightSubtitle = '';
                if (sortedWeight.length === 1) {
                    weightSubtitle = 'First entry';
                } else {
                    const changeText = totalChange > 0 ? `+${totalChange.toFixed(1)}` : totalChange.toFixed(1);
                    const changeClass = totalChange < 0 ? 'positive' : totalChange > 0 ? 'negative' : 'neutral';
                    weightSubtitle = `<span class="dashboard-card-trend ${changeClass}">${changeText} kg</span> total`;
                }

                document.getElementById('dashboard-weight-subtitle').innerHTML = weightSubtitle;
            } else {
                document.getElementById('dashboard-weight-value').textContent = '--';
                document.getElementById('dashboard-weight-subtitle').innerHTML = 'No data yet';
            }
        }

        // Initialize on page load (combined for goals, habits, notes, and weight)
        window.onFirebaseReady = function() {
            loadFromCloud(); // Load goals
            loadHabitsFromCloud(); // Load habits
            loadNotesFromCloud(); // Load notes
            loadWeightFromCloud(); // Load weight
        };

        window.onload = function() {
            // DATA MIGRATION v4.3 - Clear old cached data structure
            const appVersion = '4.3';
            const currentVersion = localStorage.getItem('appVersion');

            if (currentVersion !== appVersion) {
                console.log('🔄 Migrating to v' + appVersion + ' - Clearing old data...');

                // Clear all localStorage except userId
                const userId = localStorage.getItem('userId');
                localStorage.clear();
                if (userId) localStorage.setItem('userId', userId);
                localStorage.setItem('appVersion', appVersion);

                // Reset global variables
                personalGoals = [];
                professionalGoals = [];

                // Force reload to get fresh state
                console.log('✅ Migration complete - reloading...');
                setTimeout(() => location.reload(), 100);
                return;
            }

            // Scroll to top on page load/refresh
            window.scrollTo(0, 0);

            renderList('personal');
            renderList('professional');
            renderDashboard();
            updatePageTitle();
            updateUndoButton();
            updateFilterButtons('personal');
            updateFilterButtons('professional');
            updateSyncIdDisplay();

            // Show version and sync info on load (for debugging)
            console.log(`
╔════════════════════════════════════════╗
║   Gitesh Life Tracker v4.3 LOADED     ║
╠════════════════════════════════════════╣
║  Sync ID: ${getUserId()}
║  Goals: ${personalGoals.length}P + ${professionalGoals.length}P = ${personalGoals.length + professionalGoals.length} total
║  Firebase: ${window.firebaseReady ? '✅ Ready' : '❌ Not Ready'}
║  Online: ${navigator.onLine ? '✅ YES' : '❌ NO'}
╚════════════════════════════════════════╝
            `);

            // If Firebase is already ready, load from cloud
            if (window.firebaseReady) {
                loadFromCloud();
            }

            // Online/Offline listeners
            window.addEventListener('online', () => {
                updateOnlineStatus();
                if (window.firebaseReady) {
                    loadFromCloud(); // Sync when coming back online
                }
            });
            window.addEventListener('offline', updateOnlineStatus);

            // Visibility change listener - sync when tab becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && window.firebaseReady && navigator.onLine) {
                    console.log('👁️ Tab became visible, checking for updates...');
                    // Don't call loadFromCloud() here as the listener should auto-update
                    // Just trigger a manual check by calling manualSync in background
                    setTimeout(() => {
                        if (window.firebaseReady) {
                            console.log('🔄 Auto-syncing after visibility change');
                            loadFromCloud();
                        }
                    }, 500); // Small delay to avoid rapid syncs
                }
            });

            // Event delegation for delete buttons (backup for onclick)
            document.addEventListener('click', function(e) {
                // Delete button clicked
                if (e.target.classList.contains('delete-btn')) {
                    const listItem = e.target.closest('.checklist-item');
                    if (listItem) {
                        const goalId = listItem.getAttribute('data-id');
                        const goalType = listItem.getAttribute('data-type');
                        if (goalId && goalType) {
                            console.log(`🗑️ Delete clicked via event delegation: ${goalType} - ${goalId}`);
                            deleteItem(goalType, goalId);
                        }
                    }
                }

                // Move button clicked
                if (e.target.classList.contains('move-btn')) {
                    const listItem = e.target.closest('.checklist-item');
                    if (listItem) {
                        const goalId = listItem.getAttribute('data-id');
                        const goalType = listItem.getAttribute('data-type');
                        if (goalId && goalType) {
                            console.log(`↔️ Move clicked via event delegation: ${goalType} - ${goalId}`);
                            moveItem(goalType, goalId);
                        }
                    }
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }
                // Close modals with Escape key
                if (e.key === 'Escape') {
                    const statsModal = document.getElementById('stats-modal');
                    const helpModal = document.getElementById('help-modal');
                    if (statsModal && statsModal.style.display === 'flex') {
                        closeStats();
                    } else if (helpModal && helpModal.style.display === 'flex') {
                        closeHelp();
                    }
                }
            });
        };

        function handleSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            searchTerm = query;

            // Also update notes search
            const notesSearchInput = document.getElementById('notes-search');
            if (notesSearchInput) {
                notesSearchInput.value = query;
                searchNotes(); // Trigger notes search
            }

            // Also update documents search
            const documentsSearchInput = document.getElementById('documents-search');
            if (documentsSearchInput) {
                documentsSearchInput.value = query;
                documentsSearchTerm = query;
                renderDocuments(); // Trigger documents search
            }

            renderList('personal');
            renderList('professional');
        }

        function exportData() {
            const data = {
                personal: personalGoals,
                professional: professionalGoals,
                dailyHabits: dailyHabits,
                notes: notes,
                weightData: weightData,
                exportDate: new Date().toISOString()
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gitesh-complete-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Validate data structure
                    if (!data || typeof data !== 'object') {
                        alert('Invalid file format: Not a valid JSON object');
                        return;
                    }

                    // Validate goals arrays
                    const validateGoals = (goals) => {
                        if (!Array.isArray(goals)) return false;
                        return goals.every(g => g && typeof g === 'object' &&
                            typeof g.text === 'string' &&
                            typeof g.completed === 'boolean' &&
                            (typeof g.id === 'number' || typeof g.id === 'string'));
                    };

                    if (data.personal && !validateGoals(data.personal)) {
                        alert('Invalid file format: Personal goals are corrupted');
                        return;
                    }
                    if (data.professional && !validateGoals(data.professional)) {
                        alert('Invalid file format: Professional goals are corrupted');
                        return;
                    }

                    if (confirm('This will replace your current goals, habits, notes, weight data and sync to cloud. Continue?')) {
                        saveUndoState(); // Allow undo
                        personalGoals = deduplicateGoals(data.personal || []);
                        professionalGoals = deduplicateGoals(data.professional || []);
                        if (data.dailyHabits && typeof data.dailyHabits === 'object') {
                            dailyHabits = data.dailyHabits;
                            localStorage.setItem('dailyHabits', JSON.stringify(dailyHabits));
                            saveHabitsToCloud();
                            renderHabits();
                        }
                        if (data.notes && Array.isArray(data.notes)) {
                            notes = data.notes;
                            saveNotesLocal();
                            saveNotesToCloud();
                            renderNotes();
                        }
                        if (data.weightData && Array.isArray(data.weightData)) {
                            weightData = data.weightData;
                            sortWeightData(); // Ensure data is sorted
                            saveWeightLocal();
                            saveWeightToCloud();
                            renderWeightTracker();
                        }
                        saveData('personal');
                        saveData('professional');
                        renderList('personal');
                        renderList('professional');
                        // Cloud sync happens automatically via saveData
                        alert('All data imported and synced to cloud successfully!');
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function recommendGoal(type) {
            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const uncompletedGoals = goals.filter(g => !g.completed);

            const recElement = document.getElementById(`${type}-recommendation`);

            if (uncompletedGoals.length === 0) {
                recElement.innerHTML = '<span class="empty">Add some goals first to get recommendations!</span>';
                recElement.classList.add('empty');
                return;
            }

            const randomIndex = Math.floor(Math.random() * uncompletedGoals.length);
            const recommendedGoal = uncompletedGoals[randomIndex];

            recElement.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <input type="checkbox" onchange="completeRecommendation('${type}', '${recommendedGoal.id}')" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 600; color: #1a1a1a;">${escapeHtml(recommendedGoal.text)}</span>
                </div>
                <button class="change-btn" onclick="recommendGoal('${type}')">Change</button>
            `;
            recElement.classList.remove('empty');
        }

        function completeRecommendation(type, goalId) {
            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const goal = goals.find(g => g.id === goalId);

            if (goal) {
                goal.completed = true;
                saveData(type);
                renderList(type);
                updatePageTitle();
                showCompletionAnimation(); // Show celebration
                // Get a new recommendation
                recommendGoal(type);
            }
        }

        // Global Recommendation System
        let currentGlobalRecommendation = null;

        function getGlobalRecommendation() {
            const recommendations = [];

            // Collect uncompleted personal goals
            const uncompletedPersonal = personalGoals.filter(g => !g.completed);
            uncompletedPersonal.forEach(goal => {
                recommendations.push({
                    type: 'Personal Goal',
                    content: goal.text,
                    meta: goal.priority ? `Priority: ${goal.priority}` : '',
                    category: 'goal',
                    priority: goal.priority === 'high' ? 3 : goal.priority === 'medium' ? 2 : 1,
                    id: goal.id,
                    listType: 'personal'
                });
            });

            // Collect uncompleted professional goals
            const uncompletedProfessional = professionalGoals.filter(g => !g.completed);
            uncompletedProfessional.forEach(goal => {
                recommendations.push({
                    type: 'Professional Goal',
                    content: goal.text,
                    meta: goal.priority ? `Priority: ${goal.priority}` : '',
                    category: 'goal',
                    priority: goal.priority === 'high' ? 3 : goal.priority === 'medium' ? 2 : 1,
                    id: goal.id,
                    listType: 'professional'
                });
            });

            // Collect uncompleted daily habits
            if (dailyHabits && dailyHabits.habits) {
                const today = new Date().toLocaleDateString();
                Object.entries(dailyHabits.habits).forEach(([habitName, habitData]) => {
                    const completedToday = habitData.completions && habitData.completions.includes(today);
                    if (!completedToday) {
                        recommendations.push({
                            type: 'Daily Habit',
                            content: habitName,
                            meta: habitData.streak > 0 ? `Current streak: ${habitData.streak} days` : 'Start your streak today!',
                            category: 'habit',
                            priority: 2,
                            habitName: habitName
                        });
                    }
                });
            }

            // Collect recent notes as suggestions to review
            if (notes && notes.length > 0) {
                const recentNotes = notes.slice(0, 5); // Only consider 5 most recent notes
                recentNotes.forEach(note => {
                    recommendations.push({
                        type: 'Review Note',
                        content: note.text.length > 100 ? note.text.substring(0, 100) + '...' : note.text,
                        meta: `Created: ${new Date(note.timestamp).toLocaleDateString()}`,
                        category: 'note',
                        priority: 1,
                        noteId: note.id
                    });
                });
            }

            // Weight tracking reminder if no recent entries
            if (typeof weightData !== 'undefined' && Array.isArray(weightData)) {
                const today = new Date();
                const recentEntry = weightData.length > 0 ? new Date(weightData[weightData.length - 1].date) : null;
                if (!recentEntry || (today - recentEntry) / (1000 * 60 * 60 * 24) > 2) {
                    recommendations.push({
                        type: 'Weight Tracking',
                        content: 'Log your weight to track progress',
                        meta: recentEntry ? `Last logged: ${recentEntry.toLocaleDateString()}` : 'No entries yet',
                        category: 'weight',
                        priority: 1
                    });
                }
            }

            if (recommendations.length === 0) {
                alert('No recommendations available! Add some goals, habits, or notes to get started.');
                return;
            }

            // Smart prioritization: weight by priority and randomness
            // Higher priority items have better chance but not guaranteed
            const weightedRecommendations = [];
            recommendations.forEach(rec => {
                const weight = rec.priority || 1;
                for (let i = 0; i < weight; i++) {
                    weightedRecommendations.push(rec);
                }
            });

            // Select random recommendation from weighted pool
            const randomIndex = Math.floor(Math.random() * weightedRecommendations.length);
            const selected = weightedRecommendations[randomIndex];

            // Store for "Change" functionality
            currentGlobalRecommendation = selected;

            // Display the recommendation
            displayGlobalRecommendation(selected);
        }

        function changeGlobalRecommendation() {
            getGlobalRecommendation();
        }

        function displayGlobalRecommendation(rec) {
            const recDiv = document.getElementById('global-recommendation');
            const recType = document.getElementById('rec-type');
            const recContent = document.getElementById('rec-content');
            const recMeta = document.getElementById('rec-meta');
            const changeBtn = document.getElementById('change-global-rec');

            recType.textContent = rec.type;
            recContent.textContent = rec.content;
            recMeta.textContent = rec.meta;

            recDiv.style.display = 'block';
            changeBtn.style.display = 'inline-block';

            // Scroll to recommendation smoothly
            setTimeout(() => {
                recDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function dismissRecommendation() {
            const recDiv = document.getElementById('global-recommendation');
            const changeBtn = document.getElementById('change-global-rec');

            recDiv.style.display = 'none';
            changeBtn.style.display = 'none';
            currentGlobalRecommendation = null;
        }

        function addItem(type) {
            const input = document.getElementById(`${type}-input`);
            const text = input.value.trim().toLowerCase();
            const priority = 'medium';

            // Check for empty or whitespace-only
            if (text === '' || text.replace(/\s/g, '') === '') {
                if (input.value.trim() !== '') {
                    alert('Goal cannot be only whitespace.');
                }
                input.value = '';
                return;
            }

            // Validate text length
            if (text.length > 200) {
                alert('Goal is too long! Please keep it under 200 characters.');
                return;
            }

            const goals = type === 'personal' ? personalGoals : professionalGoals;

            // Check for duplicates
            const duplicate = goals.find(g => g.text === text);
            if (duplicate) {
                alert('This goal already exists! Please enter a different goal.');
                input.value = '';
                return;
            }

            goals.unshift({
                id: generateId(),
                text: text,
                completed: false,
                priority: priority
            });

            saveData(type);
            renderList(type);
            updatePageTitle();
            input.value = '';
            updateCharCount(type); // Reset character counter
        }

        function toggleItem(type, id) {
            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const goal = goals.find(g => g.id === id);
            if (goal) {
                const wasCompleted = goal.completed;
                goal.completed = !goal.completed;

                // Show animation if marking as complete
                if (!wasCompleted && goal.completed) {
                    showCompletionAnimation();
                }

                saveData(type);
                renderList(type);
                updatePageTitle();
            }
        }

        async function deleteItem(type, id) {
            saveUndoState();

            // Find the item to delete and clean up its chunks
            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const goal = goals.find(g => g.id === id);

            if (goal && goal.attachments) {
                for (const att of goal.attachments) {
                    if (att.chunked && att.totalChunks) {
                        // Delete chunks from Firestore
                        await deleteImageChunks(att.id, att.totalChunks);
                    }
                }
            }

            if (type === 'personal') {
                personalGoals = personalGoals.filter(g => g.id !== id);
            } else {
                professionalGoals = professionalGoals.filter(g => g.id !== id);
            }
            saveData(type);
            renderList(type);
            updatePageTitle();
        }

        function toggleDeleteButton(event) {
            // Only on mobile - toggle delete button visibility when text is clicked
            if (window.innerWidth <= 768) {
                event.stopPropagation();
                const listItem = event.target.closest('.checklist-item');

                // Remove show-delete from all other items
                document.querySelectorAll('.checklist-item').forEach(item => {
                    if (item !== listItem) {
                        item.classList.remove('show-delete');
                    }
                });

                // Toggle show-delete on current item
                listItem.classList.toggle('show-delete');
            }
        }

        function moveItem(sourceType, id) {
            saveUndoState();
            const targetType = sourceType === 'personal' ? 'professional' : 'personal';
            const sourceGoals = sourceType === 'personal' ? personalGoals : professionalGoals;
            const targetGoals = targetType === 'personal' ? personalGoals : professionalGoals;

            const goalIndex = sourceGoals.findIndex(g => g.id === id);
            if (goalIndex === -1) return;

            const goal = sourceGoals[goalIndex];
            sourceGoals.splice(goalIndex, 1);
            targetGoals.push(goal);

            saveData(sourceType);
            saveData(targetType);
            renderList(sourceType);
            renderList(targetType);
        }

        function editItem(type, id, element) {
            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const goal = goals.find(g => g.id === id);
            if (!goal) return;

            const currentText = goal.text;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'item-text';
            input.style.flex = '1';
            input.style.border = '1px solid #007bff';
            input.style.padding = '4px';
            input.style.borderRadius = '3px';

            const saveEdit = () => {
                const newText = input.value.trim().toLowerCase();
                if (newText && newText !== currentText) {
                    // Check for duplicates
                    const goals = type === 'personal' ? personalGoals : professionalGoals;
                    const duplicate = goals.find(g => g.text === newText && g.id !== goal.id);
                    if (duplicate) {
                        alert('This goal already exists! Please use a different text.');
                        return;
                    }

                    saveUndoState(); // Save state for undo
                    goal.text = newText;
                    saveData(type);
                }
                renderList(type);
            };

            input.onblur = saveEdit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    renderList(type);
                }
            };

            element.replaceWith(input);
            input.focus();
            input.select();
        }

        function renderList(type) {
            const listElement = document.getElementById(`${type}-list`);

            // Deduplicate goals to fix any duplicate entries
            if (type === 'personal') {
                personalGoals = deduplicateGoals(personalGoals);
            } else {
                professionalGoals = deduplicateGoals(professionalGoals);
            }

            const goals = type === 'personal' ? personalGoals : professionalGoals;

            // Update counter
            const completed = goals.filter(g => g.completed).length;
            const total = goals.length;
            const counterElement = document.getElementById(`${type}-counter`);

            // Update badge count
            const badgeElement = document.getElementById(`${type}-badge`);
            if (badgeElement) {
                badgeElement.textContent = total;
            }

            if (total === 0) {
                counterElement.textContent = 'No goals yet';
            } else if (completed === total) {
                counterElement.textContent = `All done! (${total} completed)`;
            } else {
                counterElement.textContent = `${completed} of ${total} completed`;
            }

            // Update clear button state
            const clearBtn = document.getElementById(`${type}-clear`);
            clearBtn.disabled = completed === 0;

            if (goals.length === 0) {
                listElement.innerHTML = '<li class="empty-state">No goals yet. Add one above!</li>';
                renderDashboard();
                return;
            }

            // Filter by search term
            let filteredGoals = goals;
            if (searchTerm) {
                filteredGoals = goals.filter(g => g.text.toLowerCase().includes(searchTerm));
            }

            // Filter by completion status
            const currentFilter = filterState[type];
            if (currentFilter === 'active') {
                filteredGoals = filteredGoals.filter(g => !g.completed);
            } else if (currentFilter === 'completed') {
                filteredGoals = filteredGoals.filter(g => g.completed);
            }

            // Sort: uncompleted first, completed at bottom, then alphabetically if enabled
            const sortedGoals = [...filteredGoals].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed - b.completed;
                }
                if (sortAlphabetically[type]) {
                    return a.text.localeCompare(b.text);
                }
                return 0;
            });

            if (sortedGoals.length === 0 && searchTerm) {
                listElement.innerHTML = '<li class="empty-state">No goals match your search</li>';
                renderDashboard();
                return;
            }

            listElement.innerHTML = sortedGoals.map(goal => {
                // Build attachments HTML
                let attachmentsHtml = '';
                if (goal.attachments && goal.attachments.length > 0) {
                    const attachmentItems = goal.attachments.map(att => {
                        const icon = getFileIcon(att.type);
                        if (att.type === 'img') {
                            const imgSrc = att.url || att.data; // Use URL if available, otherwise base64
                            return `
                                <div style="position: relative; display: inline-block;">
                                    <img src="${imgSrc}"
                                         class="attachment-thumbnail"
                                         onclick="viewAttachment('${type}', '${goal.id}', '${att.id}')"
                                         title="${escapeHtml(att.name)}"
                                         alt="${escapeHtml(att.name)}">
                                    <span class="attachment-delete" onclick="deleteAttachment('${type}', '${goal.id}', '${att.id}', event)" title="Delete attachment" style="position: absolute; top: -4px; right: -4px; background: #dc3545; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">×</span>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="attachment-item" onclick="viewAttachment('${type}', '${goal.id}', '${att.id}')" title="${escapeHtml(att.name)}">
                                    <span class="attachment-icon">${icon}</span>
                                    <span class="attachment-name">${escapeHtml(att.name)}</span>
                                    <span class="attachment-delete" onclick="deleteAttachment('${type}', '${goal.id}', '${att.id}', event)" title="Delete attachment">×</span>
                                </div>
                            `;
                        }
                    }).join('');

                    attachmentsHtml = `<div class="attachments-container">${attachmentItems}</div>`;
                }

                return `
                <li class="checklist-item ${goal.completed ? 'completed' : ''}" data-id="${goal.id}" data-type="${type}" style="display: block;">
                    <div style="display: flex; align-items: center;">
                        <button class="move-btn" onclick="moveItem('${type}', '${goal.id}')" title="Move to ${type === 'personal' ? 'Professional' : 'Personal'}">${type === 'personal' ? '→' : '←'}</button>
                        <input type="checkbox" ${goal.completed ? 'checked' : ''}
                               onchange="toggleItem('${type}', '${goal.id}')">
                        <span class="item-text" onclick="toggleDeleteButton(event)" ondblclick="editItem('${type}', '${goal.id}', this)" title="Click to show delete">${linkifyText(goal.text)}</span>
                        <button class="attach-btn" onclick="handleItemAttachment('${type}', '${goal.id}')" title="Attach file">📎</button>
                        <button class="delete-btn" onclick="deleteItem('${type}', '${goal.id}')">Delete</button>
                    </div>
                    ${attachmentsHtml}
                </li>
                `;
            }).join('');

            // Update dashboard
            renderDashboard();
        }

        function saveData(type) {
            // Set flag BEFORE saving to prevent race condition
            isSavingToCloud = true;

            try {
                if (type === 'personal') {
                    localStorage.setItem('personalGoals', JSON.stringify(personalGoals));
                } else {
                    localStorage.setItem('professionalGoals', JSON.stringify(professionalGoals));
                }
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    alert('Storage quota exceeded! Your images are too large. Try using smaller images or delete some old items.');
                    console.error('LocalStorage quota exceeded:', e);
                } else {
                    console.error('Error saving to localStorage:', e);
                }
            }
            // Also save to cloud
            saveToCloud();
        }

        function clearCompleted(type) {
            saveUndoState();
            if (type === 'personal') {
                personalGoals = personalGoals.filter(g => !g.completed);
            } else {
                professionalGoals = professionalGoals.filter(g => !g.completed);
            }
            saveData(type);
            renderList(type);
        }

        function clearAll(type) {
            if (!confirm('Are you sure you want to delete all goals?')) return;

            saveUndoState();
            if (type === 'personal') {
                personalGoals = [];
            } else {
                professionalGoals = [];
            }
            saveData(type);
            renderList(type);
            updatePageTitle();
        }

        function clearAllCompleted() {
            const personalCompleted = personalGoals.filter(g => g.completed).length;
            const professionalCompleted = professionalGoals.filter(g => g.completed).length;
            const totalCompleted = personalCompleted + professionalCompleted;

            if (totalCompleted === 0) {
                alert('No completed goals to clear.');
                return;
            }

            if (!confirm(`Clear ${totalCompleted} completed goal(s) from both lists?`)) return;

            saveUndoState();
            personalGoals = personalGoals.filter(g => !g.completed);
            professionalGoals = professionalGoals.filter(g => !g.completed);
            saveData('personal');
            saveData('professional');
            renderList('personal');
            renderList('professional');
            updatePageTitle();
        }

        function handleKeyPress(event, type) {
            if (event.key === 'Enter') {
                addItem(type);
            }
        }

        async function handlePaste(event, type) {
            // Check if clipboard has image data
            const items = (event.clipboardData || event.originalEvent?.clipboardData)?.items;

            if (!items) {
                console.log('No clipboard items available');
                return;
            }

            // First check if there's an image - if so, ONLY handle image
            let hasImage = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type && items[i].type.indexOf('image') !== -1) {
                    hasImage = true;
                    break;
                }
            }

            // If image detected, prevent ALL default behavior immediately
            if (hasImage) {
                event.preventDefault();
                event.stopPropagation();
            }

            for (let i = 0; i < items.length; i++) {
                if (items[i].type && items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    event.stopPropagation();

                    const file = items[i].getAsFile();

                    if (!file) {
                        console.log('Could not get image file from clipboard');
                        continue;
                    }

                    // Create a checklist item with the pasted image
                    const reader = new FileReader();
                    reader.onerror = function() {
                        alert('Error reading image file. Please try again.');
                    };

                    reader.onload = async function(e) {
                        let base64Data = e.target.result;
                        let fileSize = Math.round(base64Data.length * 0.75); // Approximate size

                        // Compress large images (images are stored locally only, not synced to Firestore)
                        // Reasonable limit: 2MB per image to keep localStorage happy
                        const maxImageSize = 2 * 1024 * 1024; // 2MB per image

                        if (fileSize > maxImageSize) {
                            try {
                                const compressed = await compressImage(base64Data, maxImageSize);
                                base64Data = compressed;
                                fileSize = Math.round(base64Data.length * 0.75);
                                console.log(`📸 Image compressed to ${formatFileSize(fileSize)}`);
                            } catch (compressionError) {
                                alert('Image too large and cannot be compressed enough. Please use a smaller image.');
                                console.error('Compression failed:', compressionError);
                                return;
                            }
                        }

                        const goals = type === 'personal' ? personalGoals : professionalGoals;
                        const timestamp = new Date().toLocaleString();

                        // Create goal with image attachment
                        const newGoal = {
                            id: generateId(),
                            text: `pasted image ${timestamp}`,
                            completed: false,
                            attachments: [{
                                id: generateId(),
                                name: `pasted-image-${Date.now()}.png`,
                                type: 'img',
                                size: fileSize,
                                data: base64Data,
                                uploadDate: new Date().toISOString()
                            }]
                        };

                        console.log('📸 Image pasted - adding to goals array');
                        console.log('📸 Goals before:', goals.length);

                        saveUndoState();
                        goals.unshift(newGoal);

                        console.log('📸 Goals after unshift:', goals.length);
                        console.log('📸 Image goal:', newGoal);

                        saveData(type);
                        renderList(type);
                        updatePageTitle();

                        console.log('📸 Image saved and rendered');

                        // Show success message
                        const input = document.getElementById(`${type}-input`);
                        const originalPlaceholder = input.placeholder;
                        input.placeholder = '✓ Image pasted! Added to list';
                        setTimeout(() => {
                            input.placeholder = originalPlaceholder;
                        }, 2000);
                    };

                    reader.readAsDataURL(file);
                    break; // Exit loop after finding first image
                }
            }

            // If image was detected, don't process text
            if (hasImage) {
                return; // Exit completely - image is being processed
            }

            // Handle as text paste only if no image
            {
                // Prevent default paste behavior
                event.preventDefault();

                // Get pasted text
                const pastedText = (event.clipboardData || window.clipboardData).getData('text');

                // Split by new lines and filter out empty lines
                const lines = pastedText.split(/\r?\n/).filter(line => line.trim() !== '');

                if (lines.length === 0) return;

                // If only one line, just set it in the input field
                if (lines.length === 1) {
                    const input = document.getElementById(`${type}-input`);
                    input.value = lines[0].trim().toLowerCase();
                    return;
                }

                // Multiple lines - add them all as separate goals
                const goals = type === 'personal' ? personalGoals : professionalGoals;

                let skipped = 0;
                let duplicates = 0;
                lines.forEach(line => {
                    const text = line.trim().toLowerCase();
                    if (text && text.replace(/\s/g, '') !== '') {
                        if (text.length > 200) {
                            skipped++;
                        } else if (goals.find(g => g.text === text)) {
                            duplicates++;
                        } else {
                            goals.unshift({
                                id: generateId(),
                                text: text,
                                completed: false
                            });
                        }
                    }
                });

                let message = '';
                if (skipped > 0) {
                    message += `${skipped} goal(s) too long (max 200 chars). `;
                }
                if (duplicates > 0) {
                    message += `${duplicates} duplicate(s) skipped.`;
                }
                if (message) {
                    alert(message.trim());
                }

                saveData(type);
                renderList(type);
                updatePageTitle();

                // Clear the input field
                const input = document.getElementById(`${type}-input`);
                input.value = '';
            }
        }

        // Stats functions
        function showStats() {
            const totalPersonal = personalGoals.length;
            const completedPersonal = personalGoals.filter(g => g.completed).length;
            const totalProfessional = professionalGoals.length;
            const completedProfessional = professionalGoals.filter(g => g.completed).length;
            const total = totalPersonal + totalProfessional;
            const completed = completedPersonal + completedProfessional;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            const personalRate = totalPersonal > 0 ? Math.round((completedPersonal / totalPersonal) * 100) : 0;
            const professionalRate = totalProfessional > 0 ? Math.round((completedProfessional / totalProfessional) * 100) : 0;

            // Get today's habits progress
            const today = getTodayDate();
            const todayHabits = dailyHabits[today] || {};
            const completedHabits = HABITS.filter(h => todayHabits[h] === true).length;
            const habitsRate = Math.round((completedHabits / 9) * 100);

            const statsHtml = `
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-size: 13px; color: #666; font-weight: 500;">Overall Progress</span>
                        <span style="font-size: 13px; font-weight: 600; color: var(--primary);">${completionRate}%</span>
                    </div>
                    <div style="height: 8px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; width: ${completionRate}%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #1a1a1a;">${total}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">Total</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #d1fae5; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: var(--success);">${completed}</div>
                            <div style="font-size: 11px; color: #065f46; margin-top: 4px;">Done</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #e0e7ff; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${total - completed}</div>
                            <div style="font-size: 11px; color: var(--primary-dark); margin-top: 4px;">Left</div>
                        </div>
                    </div>
                </div>

                <div style="border-top: 1px solid #e8e8e8; padding-top: 20px;">
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #666; font-weight: 500;">Personal</span>
                            <span style="font-size: 12px; color: #999;">${completedPersonal}/${totalPersonal}</span>
                        </div>
                        <div style="height: 6px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${personalRate}%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #666; font-weight: 500;">Professional</span>
                            <span style="font-size: 12px; color: #999;">${completedProfessional}/${totalProfessional}</span>
                        </div>
                        <div style="height: 6px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${professionalRate}%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #666; font-weight: 500;">Daily Habits (Today)</span>
                            <span style="font-size: 12px; color: #999;">${completedHabits}/9</span>
                        </div>
                        <div style="height: 6px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${habitsRate}%; background: linear-gradient(90deg, var(--success) 0%, #34d399 100%); transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #666; font-weight: 500;">Quick Notes</span>
                            <span style="font-size: 12px; color: #999;">${notes.length} note${notes.length !== 1 ? 's' : ''}</span>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px; margin-top: 8px;">
                            <div style="font-size: 20px; font-weight: 600; color: #92400e;">${notes.length}</div>
                            <div style="font-size: 11px; color: #92400e; margin-top: 4px;">Total Notes</div>
                        </div>
                    </div>

                    <div style="margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #666; font-weight: 500;">Weight Tracker</span>
                            <span style="font-size: 12px; color: #999;">${weightData.length} log${weightData.length !== 1 ? 's' : ''}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px;">
                            <div style="text-align: center; padding: 10px; background: #dbeafe; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #1e40af;">${weightData.length > 0 ? weightData[0].weight + ' kg' : '--'}</div>
                                <div style="font-size: 10px; color: #1e40af; margin-top: 2px;">Current</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: ${weightData.length > 0 && (weightData[0].weight - weightData[weightData.length - 1].weight) < 0 ? '#d1fae5' : '#fee2e2'}; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: ${weightData.length > 0 && (weightData[0].weight - weightData[weightData.length - 1].weight) < 0 ? '#15803d' : '#dc2626'};">${weightData.length > 0 ? ((weightData[0].weight - weightData[weightData.length - 1].weight) > 0 ? '+' : '') + (weightData[0].weight - weightData[weightData.length - 1].weight).toFixed(1) + ' kg' : '--'}</div>
                                <div style="font-size: 10px; color: ${weightData.length > 0 && (weightData[0].weight - weightData[weightData.length - 1].weight) < 0 ? '#15803d' : '#dc2626'}; margin-top: 2px;">Change</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #92400e;">${weightData.length > 0 ? weightData[weightData.length - 1].weight + ' kg' : '--'}</div>
                                <div style="font-size: 10px; color: #92400e; margin-top: 2px;">Start</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('stats-content').innerHTML = statsHtml;
            document.getElementById('stats-modal').style.display = 'flex';
        }

        function closeStats() {
            document.getElementById('stats-modal').style.display = 'none';
        }

        function showHelp() {
            document.getElementById('help-modal').style.display = 'flex';
        }

        function closeHelp() {
            document.getElementById('help-modal').style.display = 'none';
        }

        // Close modals on outside click
        document.getElementById('stats-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeStats();
        });

        document.getElementById('help-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeHelp();
        });

        // ============ DAILY HABITS TRACKER ============
        const HABITS = ['icefacial', 'workout', 'temple', 'meditation', 'noBadHabits', 'learning', 'protein', 'skincare', 'supplements'];
        let dailyHabits = {};

        // Get today's date as string (YYYY-MM-DD)
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Load habits from localStorage
        function loadHabits() {
            const stored = localStorage.getItem('dailyHabits');
            if (stored) {
                try {
                    dailyHabits = JSON.parse(stored);
                } catch (error) {
                    console.error('Error parsing stored habits:', error);
                    dailyHabits = {};
                }
            }

            // Check if we need to reset for new day
            const today = getTodayDate();
            if (!dailyHabits[today]) {
                dailyHabits[today] = {};
            }

            // Ensure all habits are initialized for today
            HABITS.forEach(habit => {
                if (dailyHabits[today][habit] === undefined) {
                    dailyHabits[today][habit] = false;
                }
            });

            saveHabitsLocal();
            renderHabits();
        }

        // Save habits to localStorage
        function saveHabitsLocal() {
            localStorage.setItem('dailyHabits', JSON.stringify(dailyHabits));
        }

        // Save habits to cloud
        async function saveHabitsToCloud() {
            if (!window.firebaseReady || !window.db) return;

            try {
                const docRef = window.firestoreDoc(window.db, 'habits', getCloudDocId());
                await window.firestoreSetDoc(docRef, {
                    habits: dailyHabits,
                    lastUpdated: new Date().toISOString()
                });
                console.log('Habits synced to cloud');
            } catch (error) {
                console.error('Error saving habits to cloud:', error);
            }
        }

        // Load habits from cloud
        async function loadHabitsFromCloud() {
            if (!window.firebaseReady || !window.db) {
                console.log('Firebase not ready for habits');
                return;
            }

            try {
                const docRef = window.firestoreDoc(window.db, 'habits', getCloudDocId());
                const docSnap = await window.firestoreGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudHabits = data.habits || {};

                    // MERGE instead of overwrite to prevent data loss
                    dailyHabits = mergeHabits(dailyHabits, cloudHabits);

                    // Save merged data back to cloud
                    await saveHabitsToCloud();

                    // Ensure today exists and all habits are initialized
                    const today = getTodayDate();
                    if (!dailyHabits[today]) {
                        dailyHabits[today] = {};
                    }

                    // Initialize any missing habits (handles new habits added)
                    HABITS.forEach(habit => {
                        if (dailyHabits[today][habit] === undefined) {
                            dailyHabits[today][habit] = false;
                        }
                    });

                    saveHabitsLocal();
                    renderHabits();
                    console.log('✅ Loaded and merged habits from cloud');
                } else {
                    // No cloud data, upload current local data
                    await saveHabitsToCloud();
                }

                // Listen for real-time updates
                window.firestoreOnSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        dailyHabits = data.habits || {};
                        const today = getTodayDate();
                        if (!dailyHabits[today]) {
                            dailyHabits[today] = {};
                        }
                        // Initialize any missing habits (handles new habits added)
                        HABITS.forEach(habit => {
                            if (dailyHabits[today][habit] === undefined) {
                                dailyHabits[today][habit] = false;
                            }
                        });

                        // Save to localStorage for offline access
                        saveHabitsLocal();

                        renderHabits();
                        console.log('🔄 Habits synced from cloud');
                    }
                });
            } catch (error) {
                console.error('Error loading habits from cloud:', error);
            }
        }

        // Calculate habit streak
        function calculateStreak(habitName) {
            let streak = 0;
            const dates = Object.keys(dailyHabits).sort().reverse(); // Most recent first

            for (const date of dates) {
                if (dailyHabits[date][habitName] === true) {
                    streak++;
                } else {
                    break; // Streak broken
                }
            }

            return streak;
        }

        // Toggle habit completion
        function toggleHabit(habitName) {
            const today = getTodayDate();

            if (!dailyHabits[today]) {
                dailyHabits[today] = {};
                HABITS.forEach(habit => {
                    dailyHabits[today][habit] = false;
                });
            }

            // Check if we're marking as complete (was false, now true)
            const wasCompleted = dailyHabits[today][habitName];

            // Toggle the habit
            dailyHabits[today][habitName] = !dailyHabits[today][habitName];

            // Save locally and to cloud
            saveHabitsLocal();
            saveHabitsToCloud();

            // Re-render
            renderHabits();

            // Show celebration animation if marking as complete
            if (!wasCompleted && dailyHabits[today][habitName]) {
                showCompletionAnimation();
            }
        }

        // Render habits UI
        function renderHabits() {
            const today = getTodayDate();

            // Ensure today's data exists and all habits are initialized
            if (!dailyHabits[today]) {
                dailyHabits[today] = {};
            }

            // Ensure all current habits exist in today's data (handles new habits added)
            HABITS.forEach(habit => {
                if (dailyHabits[today][habit] === undefined) {
                    dailyHabits[today][habit] = false;
                }
            });

            // Update each habit button
            HABITS.forEach(habitName => {
                const btn = document.getElementById(`habit-${habitName}`);
                if (btn) {
                    const isCompleted = dailyHabits[today][habitName] === true;
                    if (isCompleted) {
                        btn.classList.add('completed');
                    } else {
                        btn.classList.remove('completed');
                    }

                    // Update streak display
                    const streakEl = document.getElementById(`streak-${habitName}`);
                    if (streakEl) {
                        const streak = calculateStreak(habitName);
                        if (streak > 0) {
                            streakEl.textContent = `🔥${streak}`;
                        } else {
                            streakEl.textContent = '';
                        }
                    }
                }
            });

            // Update progress counter
            const completed = HABITS.filter(h => dailyHabits[today][h] === true).length;
            const progressEl = document.getElementById('habits-progress');
            if (progressEl) {
                progressEl.textContent = `${completed}/9`;
            }

            // Update date display
            const dateEl = document.getElementById('habits-date');
            if (dateEl) {
                const todayObj = new Date();
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                dateEl.textContent = todayObj.toLocaleDateString('en-US', options);
            }

            // Update page title to reflect habit changes
            updatePageTitle();

            // Update dashboard
            renderDashboard();
        }

        // Initialize habits on page load
        window.addEventListener('load', function() {
            loadHabits();

            // If Firebase is ready, load from cloud
            if (window.firebaseReady) {
                loadHabitsFromCloud();
            }
        });

        // Habits loading is now handled in main onFirebaseReady (line 1354)

        // Check for day change every minute
        setInterval(function() {
            const today = getTodayDate();
            if (!dailyHabits[today]) {
                console.log('New day detected! Resetting habits...');
                loadHabits();
            }
        }, 60000); // Check every minute

        // ============ NOTES SECTION ============
        let notes = [];
        let notesSearchTerm = '';
        let noteIdCounter = Date.now();
        let notesExpanded = false; // Default collapsed

        // Generate unique ID for notes with collision prevention
        function generateNoteId() {
            return noteIdCounter++ + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Toggle notes section expand/collapse
        function toggleNotesSection() {
            notesExpanded = !notesExpanded;
            const content = document.getElementById('notes-content');
            const toggleBtn = document.getElementById('notes-toggle-btn');

            if (notesExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                toggleBtn.textContent = '▼';
            } else {
                content.style.maxHeight = '0px';
                toggleBtn.textContent = '▶';
            }

            // Save state
            localStorage.setItem('notesExpanded', notesExpanded);
        }

        // Initialize notes section state
        function initNotesSection() {
            const saved = localStorage.getItem('notesExpanded');
            if (saved !== null) {
                notesExpanded = saved === 'true';
            }

            const content = document.getElementById('notes-content');
            const toggleBtn = document.getElementById('notes-toggle-btn');

            if (notesExpanded) {
                content.style.maxHeight = 'none';
                toggleBtn.textContent = '▼';
            } else {
                content.style.maxHeight = '0px';
                toggleBtn.textContent = '▶';
            }
        }

        // Load notes from localStorage
        function loadNotes() {
            const stored = localStorage.getItem('notes');
            if (stored) {
                try {
                    notes = JSON.parse(stored);
                } catch (error) {
                    console.error('Error parsing stored notes:', error);
                    notes = [];
                }
            }
            renderNotes();
        }

        // Save notes to localStorage
        function saveNotesLocal() {
            localStorage.setItem('notes', JSON.stringify(notes));
        }

        // Save notes to cloud
        async function saveNotesToCloud() {
            if (!window.firebaseReady || !window.db) return;

            try {
                const docRef = window.firestoreDoc(window.db, 'notes', getCloudDocId());
                await window.firestoreSetDoc(docRef, {
                    notes: notes,
                    lastUpdated: new Date().toISOString()
                });
                console.log('Notes synced to cloud');
            } catch (error) {
                console.error('Error saving notes to cloud:', error);
            }
        }

        // Load notes from cloud
        async function loadNotesFromCloud() {
            if (!window.firebaseReady || !window.db) {
                console.log('Firebase not ready for notes');
                return;
            }

            try {
                const docRef = window.firestoreDoc(window.db, 'notes', getCloudDocId());
                const docSnap = await window.firestoreGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudNotes = data.notes || [];

                    // MERGE instead of overwrite to prevent data loss
                    notes = mergeNotes(notes, cloudNotes);

                    // Save merged data back to cloud
                    await saveNotesToCloud();

                    saveNotesLocal();
                    renderNotes();
                    console.log('✅ Loaded and merged notes from cloud');
                } else {
                    await saveNotesToCloud();
                }

                // Listen for real-time updates
                window.firestoreOnSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        notes = data.notes || [];

                        // Save to localStorage for offline access
                        saveNotesLocal();

                        renderNotes();
                        console.log('🔄 Notes synced from cloud');
                    }
                });
            } catch (error) {
                console.error('Error loading notes from cloud:', error);
            }
        }

        // Add note
        function addNote() {
            const input = document.getElementById('note-input');
            const text = input.value.trim();

            if (text === '' || text.replace(/\s/g, '') === '') {
                if (input.value.trim() !== '') {
                    alert('Note cannot be only whitespace.');
                }
                input.value = '';
                return;
            }

            if (text.length > 500) {
                alert('Note is too long! Please keep it under 500 characters.');
                return;
            }

            const newNote = {
                id: generateNoteId(),
                text: text,
                timestamp: new Date().toISOString()
            };

            notes.unshift(newNote);
            saveNotesLocal();
            saveNotesToCloud();
            renderNotes();
            input.value = '';
            updateNoteCharCount();
        }

        // Delete note
        function deleteNote(id) {
            if (!confirm('Delete this note?')) return;
            notes = notes.filter(n => n.id !== id);
            saveNotesLocal();
            saveNotesToCloud();
            renderNotes();
        }

        // Edit note
        function editNote(id, element) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            const currentText = note.text;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.width = '100%';
            input.style.padding = '8px';
            input.style.border = '1px solid #007bff';
            input.style.borderRadius = '4px';
            input.style.fontSize = '13px';
            input.maxLength = 500;

            const saveEdit = () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    if (newText.length > 500) {
                        alert('Note is too long! Please keep it under 500 characters.');
                        return;
                    }
                    note.text = newText;
                    note.timestamp = new Date().toISOString();
                    saveNotesLocal();
                    saveNotesToCloud();
                }
                renderNotes();
            };

            input.onblur = saveEdit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    renderNotes();
                }
            };

            element.replaceWith(input);
            input.focus();
            input.select();
        }

        // Search notes
        function searchNotes() {
            notesSearchTerm = document.getElementById('notes-search').value.toLowerCase().trim();
            renderNotes();
        }

        // Clear all notes
        function clearAllNotes() {
            if (notes.length === 0) {
                alert('No notes to clear.');
                return;
            }

            if (!confirm(`Delete all ${notes.length} notes?`)) return;

            notes = [];
            saveNotesLocal();
            saveNotesToCloud();
            renderNotes();
        }

        // Update note character count
        function updateNoteCharCount() {
            const input = document.getElementById('note-input');
            const counter = document.getElementById('note-char-count');
            if (input && counter) {
                const length = input.value.length;
                counter.textContent = `${length}/500`;

                if (length > 450) {
                    counter.style.color = '#EF4444';
                    counter.style.fontWeight = '600';
                } else if (length > 400) {
                    counter.style.color = '#F59E0B';
                    counter.style.fontWeight = '500';
                } else {
                    counter.style.color = '#999';
                    counter.style.fontWeight = 'normal';
                }
            }
        }

        // Format timestamp
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Render notes
        function renderNotes() {
            const listElement = document.getElementById('notes-list');
            const countElement = document.getElementById('notes-count');

            // Update count badge
            if (countElement) {
                countElement.textContent = notes.length;
            }

            if (notes.length === 0) {
                listElement.innerHTML = '<div class="empty-state">No notes yet. Add one above!</div>';
                return;
            }

            // Filter by search term
            let filteredNotes = notes;
            if (notesSearchTerm) {
                filteredNotes = notes.filter(n => n.text.toLowerCase().includes(notesSearchTerm));
            }

            if (filteredNotes.length === 0 && notesSearchTerm) {
                listElement.innerHTML = '<div class="empty-state">No notes match your search</div>';
                return;
            }

            listElement.innerHTML = filteredNotes.map(note => `
                <div class="note-item" data-id="${note.id}">
                    <div class="note-content" ondblclick="editNote('${note.id}', this)" title="Double-click to edit">${escapeHtml(note.text)}</div>
                    <div class="note-footer">
                        <span class="note-timestamp">${formatTimestamp(note.timestamp)}</span>
                        <button class="note-delete" onclick="deleteNote('${note.id}')">Delete</button>
                    </div>
                </div>
            `).join('');

            // Update max-height if expanded (to accommodate new notes)
            if (notesExpanded) {
                const content = document.getElementById('notes-content');
                if (content) {
                    setTimeout(() => {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }, 10);
                }
            }
        }

        // Handle Enter key in note input
        function handleNoteKeyPress(event) {
            if (event.key === 'Enter') {
                addNote();
            }
        }

        // Initialize notes on page load
        window.addEventListener('load', function() {
            loadNotes();
            initNotesSection();

            // Character counter for note input
            const noteInput = document.getElementById('note-input');
            if (noteInput) {
                noteInput.addEventListener('input', updateNoteCharCount);
            }

            // If Firebase is ready, load from cloud
            if (window.firebaseReady) {
                loadNotesFromCloud();
            }
        });

        // Notes loading is now handled in main onFirebaseReady (line 1354)

        // ============ FILE UTILITIES ============
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes

        // Get file type category
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['pdf'].includes(ext)) return 'pdf';
            if (['doc', 'docx', 'txt', 'rtf'].includes(ext)) return 'doc';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'xls';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) return 'img';
            return 'other';
        }

        // Get file icon based on type
        function getFileIcon(type) {
            const icons = {
                'pdf': '📄',
                'doc': '📝',
                'xls': '📊',
                'img': '🖼️',
                'other': '📎'
            };
            return icons[type] || '📎';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // Compress image if needed
        async function compressImage(dataUrl, maxSize = MAX_FILE_SIZE) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.9;

                    // Calculate initial size
                    let currentSize = Math.ceil((dataUrl.length * 3) / 4);

                    // If already under max size, return as-is
                    if (currentSize <= maxSize) {
                        resolve(dataUrl);
                        return;
                    }

                    // Reduce dimensions if needed
                    const maxDimension = 1920;
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (height / width) * maxDimension;
                            width = maxDimension;
                        } else {
                            width = (width / height) * maxDimension;
                            height = maxDimension;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Try different quality levels
                    let compressed = canvas.toDataURL('image/jpeg', quality);
                    currentSize = Math.ceil((compressed.length * 3) / 4);

                    while (currentSize > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        compressed = canvas.toDataURL('image/jpeg', quality);
                        currentSize = Math.ceil((compressed.length * 3) / 4);
                    }

                    if (currentSize > maxSize) {
                        reject(new Error('Unable to compress image to acceptable size'));
                    } else {
                        resolve(compressed);
                    }
                };
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = dataUrl;
            });
        }

        // Read file as base64
        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        // ============ DOCUMENTS MANAGEMENT ============
        let documents = [];
        let documentsSearchTerm = '';
        let documentIdCounter = Date.now();
        let documentsExpanded = false; // Default collapsed

        // Generate unique ID for documents
        function generateDocumentId() {
            return documentIdCounter++ + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Toggle documents section expand/collapse
        function toggleDocumentsSection() {
            documentsExpanded = !documentsExpanded;
            const content = document.getElementById('documents-content');
            const toggleBtn = document.getElementById('documents-toggle-btn');

            if (documentsExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                toggleBtn.textContent = '▼';
            } else {
                content.style.maxHeight = '0px';
                toggleBtn.textContent = '▶';
            }

            // Save state
            localStorage.setItem('documentsExpanded', documentsExpanded);
        }

        // Initialize documents section state
        function initDocumentsSection() {
            const saved = localStorage.getItem('documentsExpanded');
            if (saved !== null) {
                documentsExpanded = saved === 'true';
            }

            const content = document.getElementById('documents-content');
            const toggleBtn = document.getElementById('documents-toggle-btn');

            if (documentsExpanded) {
                content.style.maxHeight = 'none';
                toggleBtn.textContent = '▼';
            } else {
                content.style.maxHeight = '0px';
                toggleBtn.textContent = '▶';
            }
        }

        // Load documents from localStorage
        function loadDocuments() {
            const stored = localStorage.getItem('documents');
            if (stored) {
                try {
                    documents = JSON.parse(stored);
                } catch (error) {
                    console.error('Error parsing documents:', error);
                    documents = [];
                }
            }
            renderDocuments();
        }

        // Save documents to localStorage
        function saveDocumentsLocal() {
            localStorage.setItem('documents', JSON.stringify(documents));
        }

        // Save documents to cloud
        async function saveDocumentsToCloud() {
            if (!window.firebaseReady || !window.db) return;

            try {
                const cloudDocId = getCloudDocId();
                if (!cloudDocId) return;

                const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const docRef = doc(window.db, 'users', cloudDocId);

                await setDoc(docRef, {
                    documents: documents
                }, { merge: true });
            } catch (error) {
                console.error('Error saving documents to cloud:', error);
            }
        }

        // Load documents from cloud
        async function loadDocumentsFromCloud() {
            if (!window.firebaseReady || !window.db) return;

            try {
                const cloudDocId = getCloudDocId();
                if (!cloudDocId) return;

                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const docRef = doc(window.db, 'users', cloudDocId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().documents) {
                    documents = docSnap.data().documents;
                    saveDocumentsLocal();
                    renderDocuments();
                }
            } catch (error) {
                console.error('Error loading documents from cloud:', error);
            }
        }

        // Handle document upload
        async function handleDocumentUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (let file of files) {
                try {
                    // Check file size
                    if (file.size > MAX_FILE_SIZE) {
                        alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                        continue;
                    }

                    // Prompt for document name
                    const customName = prompt(`Enter a name for this document (or leave blank to use original name):`, file.name);
                    if (customName === null) {
                        // User cancelled
                        continue;
                    }
                    const documentName = customName.trim() || file.name;

                    // Read file
                    let fileData = await readFileAsBase64(file);
                    const fileType = getFileType(file.name);

                    // Compress images if needed
                    if (fileType === 'img') {
                        try {
                            fileData = await compressImage(fileData, MAX_FILE_SIZE);
                        } catch (error) {
                            console.error('Image compression failed:', error);
                            alert(`Failed to compress image "${file.name}". Please try a smaller file.`);
                            continue;
                        }
                    }

                    // Create document object
                    const newDocument = {
                        id: generateDocumentId(),
                        name: documentName,
                        type: fileType,
                        size: file.size,
                        data: fileData,
                        uploadDate: new Date().toISOString()
                    };

                    documents.unshift(newDocument);
                } catch (error) {
                    console.error('Error uploading file:', error);
                    alert(`Failed to upload "${file.name}".`);
                }
            }

            saveDocumentsLocal();
            saveDocumentsToCloud();
            renderDocuments();

            // Clear input
            event.target.value = '';
        }

        // Delete document
        function deleteDocument(id) {
            if (!confirm('Delete this document?')) return;
            documents = documents.filter(d => d.id !== id);
            saveDocumentsLocal();
            saveDocumentsToCloud();
            renderDocuments();
        }

        // Rename document
        function renameDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;

            const newName = prompt('Enter new name for this document:', doc.name);
            if (newName === null || newName.trim() === '') return;

            doc.name = newName.trim();
            saveDocumentsLocal();
            saveDocumentsToCloud();
            renderDocuments();
        }

        // Download document
        function downloadDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;

            const link = document.createElement('a');
            link.href = doc.data;
            link.download = doc.name;
            link.click();
        }

        // Preview document (images only)
        function previewDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;

            if (doc.type === 'img') {
                const modal = document.getElementById('preview-modal');
                const img = document.getElementById('preview-image');
                img.src = doc.data;
                modal.classList.add('active');
            } else {
                downloadDocument(id);
            }
        }

        // Close preview modal
        function closePreview() {
            const modal = document.getElementById('preview-modal');
            modal.classList.remove('active');
        }

        // Search documents
        function searchDocuments() {
            documentsSearchTerm = document.getElementById('documents-search').value.toLowerCase().trim();
            renderDocuments();
        }

        // Clear all documents
        function clearAllDocuments() {
            if (documents.length === 0) {
                alert('No documents to clear.');
                return;
            }

            if (!confirm(`Delete all ${documents.length} documents?`)) return;

            documents = [];
            saveDocumentsLocal();
            saveDocumentsToCloud();
            renderDocuments();
        }

        // Render documents
        function renderDocuments() {
            const listElement = document.getElementById('documents-list');
            const countElement = document.getElementById('documents-count');

            // Update count badge
            if (countElement) {
                countElement.textContent = documents.length;
            }

            if (documents.length === 0) {
                listElement.innerHTML = '<div class="empty-state">No documents yet. Upload one above!</div>';
                return;
            }

            // Filter by search term
            let filteredDocuments = documents;
            if (documentsSearchTerm) {
                filteredDocuments = documents.filter(d =>
                    d.name.toLowerCase().includes(documentsSearchTerm)
                );
            }

            if (filteredDocuments.length === 0 && documentsSearchTerm) {
                listElement.innerHTML = '<div class="empty-state">No documents match your search</div>';
                return;
            }

            listElement.innerHTML = filteredDocuments.map(doc => {
                const uploadDate = new Date(doc.uploadDate).toLocaleDateString();
                const icon = getFileIcon(doc.type);
                const previewBtn = doc.type === 'img'
                    ? `<button class="document-preview-btn" onclick="previewDocument('${doc.id}')">Preview</button>`
                    : '';

                return `
                    <div class="document-item" data-id="${doc.id}">
                        <div class="document-icon ${doc.type}">${icon}</div>
                        <div class="document-info">
                            <div class="document-name" ondblclick="renameDocument('${doc.id}')" onclick="previewDocument('${doc.id}')" title="${escapeHtml(doc.name)} (double-click to rename)">${escapeHtml(doc.name)}</div>
                            <div class="document-meta">
                                <span>${formatFileSize(doc.size)}</span>
                                <span>${uploadDate}</span>
                            </div>
                        </div>
                        <div class="document-actions">
                            ${previewBtn}
                            <button class="document-download-btn" onclick="downloadDocument('${doc.id}')">Download</button>
                            <button class="document-delete-btn" onclick="deleteDocument('${doc.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Update max-height if expanded
            if (documentsExpanded) {
                const content = document.getElementById('documents-content');
                if (content) {
                    setTimeout(() => {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }, 10);
                }
            }
        }

        // Setup drag and drop for documents
        function setupDocumentsDragDrop() {
            const uploadArea = document.getElementById('upload-area');
            if (!uploadArea) return;

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // Create a fake event object to reuse handleDocumentUpload
                    const fakeEvent = {
                        target: { files: files, value: '' }
                    };
                    await handleDocumentUpload(fakeEvent);
                }
            });
        }

        // Initialize documents on page load
        window.addEventListener('load', function() {
            loadDocuments();
            initDocumentsSection();
            setupDocumentsDragDrop();

            // If Firebase is ready, load from cloud
            if (window.firebaseReady) {
                loadDocumentsFromCloud();
            }
        });

        // ============ CHECKLIST ITEM ATTACHMENTS ============
        let attachmentIdCounter = Date.now();

        // Generate unique ID for attachments
        function generateAttachmentId() {
            return attachmentIdCounter++ + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Handle attachment upload for checklist item
        async function handleItemAttachment(type, goalId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '*/*';
            input.multiple = true;

            input.onchange = async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                const goals = type === 'personal' ? personalGoals : professionalGoals;
                const goal = goals.find(g => g.id === goalId);
                if (!goal) return;

                // Initialize attachments array if it doesn't exist
                if (!goal.attachments) {
                    goal.attachments = [];
                }

                for (let file of files) {
                    try {
                        // Check file size
                        if (file.size > MAX_FILE_SIZE) {
                            alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                            continue;
                        }

                        // Prompt for attachment name
                        const customName = prompt(`Enter a name for this attachment (or leave blank to use original name):`, file.name);
                        if (customName === null) {
                            // User cancelled
                            continue;
                        }
                        const attachmentName = customName.trim() || file.name;

                        // Read file
                        let fileData = await readFileAsBase64(file);
                        const fileType = getFileType(file.name);

                        // Compress images if needed
                        if (fileType === 'img') {
                            try {
                                fileData = await compressImage(fileData, MAX_FILE_SIZE);
                            } catch (error) {
                                console.error('Image compression failed:', error);
                                alert(`Failed to compress image "${file.name}". Please try a smaller file.`);
                                continue;
                            }
                        }

                        // Create attachment object
                        const newAttachment = {
                            id: generateAttachmentId(),
                            name: attachmentName,
                            type: fileType,
                            size: file.size,
                            data: fileData,
                            uploadDate: new Date().toISOString()
                        };

                        goal.attachments.push(newAttachment);
                    } catch (error) {
                        console.error('Error uploading attachment:', error);
                        alert(`Failed to upload "${file.name}".`);
                    }
                }

                saveData(type);
                renderList(type);
            };

            input.click();
        }

        // Delete attachment from checklist item
        async function deleteAttachment(type, goalId, attachmentId, event) {
            event.stopPropagation();

            if (!confirm('Delete this attachment?')) return;

            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const goal = goals.find(g => g.id === goalId);
            if (!goal || !goal.attachments) return;

            // Find the attachment and delete its chunks if it's chunked
            const attachment = goal.attachments.find(a => a.id === attachmentId);
            if (attachment && attachment.chunked && attachment.totalChunks) {
                await deleteImageChunks(attachmentId, attachment.totalChunks);
            }

            goal.attachments = goal.attachments.filter(a => a.id !== attachmentId);

            saveData(type);
            renderList(type);
        }

        // Preview/download attachment
        function viewAttachment(type, goalId, attachmentId) {
            const goals = type === 'personal' ? personalGoals : professionalGoals;
            const goal = goals.find(g => g.id === goalId);
            if (!goal || !goal.attachments) return;

            const attachment = goal.attachments.find(a => a.id === attachmentId);
            if (!attachment) return;

            if (attachment.type === 'img') {
                const modal = document.getElementById('preview-modal');
                const img = document.getElementById('preview-image');
                img.src = attachment.data;
                modal.classList.add('active');
            } else {
                // Download file
                const link = document.createElement('a');
                link.href = attachment.data;
                link.download = attachment.name;
                link.click();
            }
        }

        // ============ WEIGHT TRACKER ============
        let weightData = [];
        let weightExpanded = false; // Default collapsed
        let userHeight = null; // in cm
        let targetWeight = null; // in kg

        // Sort weight data by date (newest first)
        function sortWeightData() {
            weightData.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Load weight data from localStorage
        function loadWeightData() {
            const stored = localStorage.getItem('weightData');
            if (stored) {
                try {
                    weightData = JSON.parse(stored);
                    sortWeightData(); // Ensure data is sorted
                } catch (error) {
                    console.error('Error parsing weight data:', error);
                    weightData = [];
                }
            }
            renderWeightTracker();
        }

        // Save weight data to localStorage
        function saveWeightLocal() {
            localStorage.setItem('weightData', JSON.stringify(weightData));
        }

        // Save weight to cloud
        async function saveWeightToCloud() {
            if (!window.firebaseReady || !window.db) return;

            try {
                const docRef = window.firestoreDoc(window.db, 'weight', getCloudDocId());
                await window.firestoreSetDoc(docRef, {
                    weightData: weightData,
                    height: userHeight,
                    targetWeight: targetWeight,
                    lastUpdated: new Date().toISOString()
                });
                console.log('Weight data synced to cloud');
            } catch (error) {
                console.error('Error saving weight to cloud:', error);
            }
        }

        // Save height and target weight
        function saveHeightAndTarget() {
            const heightInput = document.getElementById('height-input');
            const targetInput = document.getElementById('target-weight-input');

            userHeight = heightInput.value ? parseFloat(heightInput.value) : null;
            targetWeight = targetInput.value ? parseFloat(targetInput.value) : null;

            // Save to localStorage
            if (userHeight) localStorage.setItem('userHeight', userHeight);
            else localStorage.removeItem('userHeight');

            if (targetWeight) localStorage.setItem('targetWeight', targetWeight);
            else localStorage.removeItem('targetWeight');

            // Save to cloud
            saveWeightToCloud();

            // Re-render to update BMI and target progress
            renderWeightTracker();
        }

        // Load height and target weight
        function loadHeightAndTarget() {
            const storedHeight = localStorage.getItem('userHeight');
            const storedTarget = localStorage.getItem('targetWeight');

            userHeight = storedHeight ? parseFloat(storedHeight) : null;
            targetWeight = storedTarget ? parseFloat(storedTarget) : null;

            // Update input fields
            const heightInput = document.getElementById('height-input');
            const targetInput = document.getElementById('target-weight-input');

            if (heightInput && userHeight) heightInput.value = userHeight;
            if (targetInput && targetWeight) targetInput.value = targetWeight;
        }

        // Load weight from cloud
        async function loadWeightFromCloud() {
            if (!window.firebaseReady || !window.db) {
                console.log('Firebase not ready for weight');
                return;
            }

            try {
                const docRef = window.firestoreDoc(window.db, 'weight', getCloudDocId());
                const docSnap = await window.firestoreGetDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const cloudWeight = data.weightData || [];

                    // Load height and target weight from cloud
                    if (data.height) {
                        userHeight = data.height;
                        localStorage.setItem('userHeight', userHeight);
                    }
                    if (data.targetWeight) {
                        targetWeight = data.targetWeight;
                        localStorage.setItem('targetWeight', targetWeight);
                    }

                    // Update input fields
                    loadHeightAndTarget();

                    // MERGE instead of overwrite to prevent data loss
                    weightData = mergeWeightData(weightData, cloudWeight);

                    sortWeightData(); // Ensure data is sorted

                    // Save merged data back to cloud
                    await saveWeightToCloud();

                    saveWeightLocal();
                    renderWeightTracker();
                    console.log('✅ Loaded and merged weight from cloud');
                } else {
                    await saveWeightToCloud();
                }

                // Listen for real-time updates
                window.firestoreOnSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        weightData = data.weightData || [];

                        // Load height and target weight from cloud
                        if (data.height) {
                            userHeight = data.height;
                            localStorage.setItem('userHeight', userHeight);
                        }
                        if (data.targetWeight) {
                            targetWeight = data.targetWeight;
                            localStorage.setItem('targetWeight', targetWeight);
                        }

                        // Update input fields
                        loadHeightAndTarget();

                        sortWeightData(); // Ensure data is sorted

                        // Save to localStorage for offline access
                        saveWeightLocal();

                        renderWeightTracker();
                        console.log('🔄 Weight synced from cloud');
                    }
                });
            } catch (error) {
                console.error('Error loading weight from cloud:', error);
            }
        }

        // Toggle weight section
        function toggleWeightSection() {
            weightExpanded = !weightExpanded;
            const content = document.getElementById('weight-content');
            const toggleBtn = document.getElementById('weight-toggle-btn');

            if (weightExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                toggleBtn.textContent = '▼';
            } else {
                content.style.maxHeight = '0px';
                toggleBtn.textContent = '▶';
            }

            localStorage.setItem('weightExpanded', weightExpanded);
        }

        // Initialize weight section state
        function initWeightSection() {
            const saved = localStorage.getItem('weightExpanded');
            if (saved !== null) {
                weightExpanded = saved === 'true';
            }

            const content = document.getElementById('weight-content');
            const toggleBtn = document.getElementById('weight-toggle-btn');

            if (weightExpanded) {
                content.style.maxHeight = 'none';
                toggleBtn.textContent = '▼';
            } else {
                content.style.maxHeight = '0px';
                toggleBtn.textContent = '▶';
            }

            // Load height and target weight
            loadHeightAndTarget();
        }

        // Add weight entry
        function addWeight() {
            const input = document.getElementById('weight-input');
            const weight = parseFloat(input.value);

            if (!weight || weight <= 0 || weight > 300) {
                alert('Please enter a valid weight (greater than 0, up to 300 kg)');
                return;
            }

            const today = getTodayDate();

            // Check if already logged today
            const existingIndex = weightData.findIndex(entry => entry.date === today);
            if (existingIndex !== -1) {
                if (!confirm('You already logged weight today. Update it?')) return;
                weightData[existingIndex].weight = weight;
            } else {
                weightData.unshift({
                    date: today,
                    weight: weight,
                    timestamp: new Date().toISOString()
                });
            }

            saveWeightLocal();
            saveWeightToCloud();
            renderWeightTracker();
            input.value = '';
        }

        // Edit weight entry
        function editWeight(date, currentWeight) {
            const newWeight = prompt(`Edit weight for ${date}:`, currentWeight);
            if (newWeight === null) return; // Cancelled

            const weight = parseFloat(newWeight);
            if (!weight || weight <= 0 || weight > 300) {
                alert('Please enter a valid weight (greater than 0, up to 300 kg)');
                return;
            }

            const entry = weightData.find(e => e.date === date);
            if (entry) {
                entry.weight = weight;
                entry.timestamp = new Date().toISOString(); // Update timestamp
                saveWeightLocal();
                saveWeightToCloud();
                renderWeightTracker();
            }
        }

        // Delete weight entry
        function deleteWeight(date) {
            if (!confirm('Delete this weight entry?')) return;
            weightData = weightData.filter(entry => entry.date !== date);
            saveWeightLocal();
            saveWeightToCloud();
            renderWeightTracker();
        }

        // Render weight tracker
        function renderWeightTracker() {
            // Update count
            const countEl = document.getElementById('weight-count');
            if (countEl) {
                countEl.textContent = `${weightData.length} log${weightData.length !== 1 ? 's' : ''}`;
            }

            // Update stats
            if (weightData.length > 0) {
                const current = weightData[0].weight;
                const start = weightData[weightData.length - 1].weight;
                const totalChange = current - start;

                document.getElementById('current-weight').textContent = `${current} kg`;
                document.getElementById('start-weight').textContent = `${start} kg`;

                // Total change from start
                const changeTotalEl = document.getElementById('weight-change-total');
                const totalChangeText = totalChange > 0 ? `+${totalChange.toFixed(1)}` : totalChange.toFixed(1);
                changeTotalEl.textContent = `${totalChangeText} kg`;
                changeTotalEl.style.color = totalChange > 0 ? '#dc2626' : totalChange < 0 ? '#15803d' : '#666';
                changeTotalEl.parentElement.style.background = totalChange > 0 ? '#fee2e2' : totalChange < 0 ? '#f0fdf4' : '#f8f9fa';
                changeTotalEl.parentElement.style.borderColor = totalChange > 0 ? '#fecaca' : totalChange < 0 ? '#dcfce7' : '#e8e8e8';

                // Change from previous entry
                if (weightData.length > 1) {
                    const previous = weightData[1].weight;
                    const prevChange = current - previous;
                    const changePrevEl = document.getElementById('weight-change-prev');
                    const prevChangeText = prevChange > 0 ? `+${prevChange.toFixed(1)}` : prevChange.toFixed(1);
                    changePrevEl.textContent = `${prevChangeText} kg`;
                    changePrevEl.style.color = prevChange > 0 ? '#dc2626' : prevChange < 0 ? '#15803d' : '#666';
                    changePrevEl.parentElement.style.background = prevChange > 0 ? '#fee2e2' : prevChange < 0 ? '#f0fdf4' : '#f8f9fa';
                    changePrevEl.parentElement.style.borderColor = prevChange > 0 ? '#fecaca' : prevChange < 0 ? '#dcfce7' : '#e8e8e8';
                } else {
                    document.getElementById('weight-change-prev').textContent = 'First entry';
                    document.getElementById('weight-change-prev').style.fontSize = '11px';
                }

                // Calculate and display BMI
                const bmiValueEl = document.getElementById('bmi-value');
                const bmiCategoryEl = document.getElementById('bmi-category');
                if (userHeight && userHeight > 0) {
                    const heightInMeters = userHeight / 100;
                    const bmi = current / (heightInMeters * heightInMeters);
                    let category = '';

                    if (bmi < 18.5) {
                        category = 'Underweight';
                    } else if (bmi < 25) {
                        category = 'Normal';
                    } else if (bmi < 30) {
                        category = 'Overweight';
                    } else {
                        category = 'Obese';
                    }

                    bmiValueEl.textContent = bmi.toFixed(1);
                    bmiCategoryEl.textContent = category;
                } else {
                    bmiValueEl.textContent = '--';
                    bmiCategoryEl.textContent = 'BMI';
                }

                // Calculate and display target progress
                const targetProgressEl = document.getElementById('target-progress');
                if (targetWeight && targetWeight > 0) {
                    const difference = current - targetWeight;
                    const displayText = difference > 0 ? `${difference.toFixed(1)} kg over` : difference < 0 ? `${Math.abs(difference).toFixed(1)} kg to go` : 'At target!';
                    targetProgressEl.textContent = displayText;
                } else {
                    targetProgressEl.textContent = '--';
                }
            } else {
                document.getElementById('current-weight').textContent = '--';
                document.getElementById('start-weight').textContent = '--';
                document.getElementById('weight-change-total').textContent = '--';
                document.getElementById('weight-change-prev').textContent = '--';
                document.getElementById('bmi-value').textContent = '--';
                document.getElementById('bmi-category').textContent = 'BMI';
                document.getElementById('target-progress').textContent = '--';
            }

            // Render chart
            renderWeightChart();

            // Render log
            const logEl = document.getElementById('weight-log');
            if (weightData.length === 0) {
                logEl.innerHTML = '<div class="empty-state">No weight entries yet. Log your weight above!</div>';
                renderDashboard();
                return;
            }

            logEl.innerHTML = weightData.slice(0, 7).map(entry => {
                const date = new Date(entry.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return `
                    <div class="weight-entry">
                        <div ondblclick="editWeight('${entry.date}', '${entry.weight}')" style="cursor: pointer; flex: 1;" title="Double-click to edit">
                            <span class="weight-value">${entry.weight} kg</span>
                            <span class="weight-date">${formattedDate}</span>
                        </div>
                        <button class="weight-delete" onclick="deleteWeight('${entry.date}')">Delete</button>
                    </div>
                `;
            }).join('');

            // Update max-height if expanded
            if (weightExpanded) {
                const content = document.getElementById('weight-content');
                if (content) {
                    setTimeout(() => {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }, 10);
                }
            }

            // Update dashboard
            renderDashboard();
        }

        // Render weight chart
        function renderWeightChart() {
            const canvas = document.getElementById('weight-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            // Handle retina displays
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            const displayWidth = rect.width;
            const displayHeight = 200;

            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';

            ctx.scale(dpr, dpr);

            const width = displayWidth;
            const height = displayHeight;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            if (weightData.length === 0) {
                ctx.fillStyle = '#9ca3af';
                ctx.font = '13px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Log your weight to see the trend', width / 2, height / 2);
                return;
            }

            // Get last 20 entries or all data
            const chartData = weightData.slice(0, 20).reverse();
            const weights = chartData.map(e => e.weight);
            const minWeight = Math.min(...weights);
            const maxWeight = Math.max(...weights);
            const range = maxWeight - minWeight || 2;

            // Add 10% padding to range for better visualization
            const paddedMin = minWeight - range * 0.1;
            const paddedMax = maxWeight + range * 0.1;
            const paddedRange = paddedMax - paddedMin;

            const padding = { top: 30, right: 20, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Draw subtle grid lines
            ctx.strokeStyle = '#f3f4f6';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }

            // Y-axis labels
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                const weight = paddedMax - (paddedRange / 4) * i;
                ctx.fillStyle = '#6b7280';
                ctx.font = '11px -apple-system, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(weight.toFixed(1), padding.left - 10, y + 4);
            }

            // Draw area fill under line
            if (chartData.length > 1) {
                const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.15)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.01)');

                ctx.fillStyle = gradient;
                ctx.beginPath();

                const firstX = padding.left;
                ctx.moveTo(firstX, height - padding.bottom);

                chartData.forEach((entry, i) => {
                    const x = padding.left + (chartWidth / (chartData.length - 1)) * i;
                    const normalizedY = (entry.weight - paddedMin) / paddedRange;
                    const y = height - padding.bottom - (normalizedY * chartHeight);
                    ctx.lineTo(x, y);
                });

                const lastX = padding.left + chartWidth;
                ctx.lineTo(lastX, height - padding.bottom);
                ctx.closePath();
                ctx.fill();

                // Draw smooth line
                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 2.5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();

                chartData.forEach((entry, i) => {
                    const x = padding.left + (chartWidth / (chartData.length - 1)) * i;
                    const normalizedY = (entry.weight - paddedMin) / paddedRange;
                    const y = height - padding.bottom - (normalizedY * chartHeight);

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });

                ctx.stroke();

                // Draw points
                chartData.forEach((entry, i) => {
                    const x = padding.left + (chartWidth / (chartData.length - 1)) * i;
                    const normalizedY = (entry.weight - paddedMin) / paddedRange;
                    const y = height - padding.bottom - (normalizedY * chartHeight);

                    // Point glow
                    ctx.fillStyle = 'rgba(99, 102, 241, 0.2)';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, Math.PI * 2);
                    ctx.fill();

                    // Point
                    ctx.fillStyle = '#6366f1';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();

                    // White center
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Draw weight labels (first, last, and highest/lowest)
                const maxIndex = weights.indexOf(maxWeight);
                const minIndex = weights.indexOf(minWeight);

                chartData.forEach((entry, i) => {
                    if (i === 0 || i === chartData.length - 1 || i === maxIndex || i === minIndex) {
                        const x = padding.left + (chartWidth / (chartData.length - 1)) * i;
                        const normalizedY = (entry.weight - paddedMin) / paddedRange;
                        const y = height - padding.bottom - (normalizedY * chartHeight);

                        // Label background
                        ctx.fillStyle = '#ffffff';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetY = 1;

                        const labelWidth = 38;
                        const labelHeight = 16;
                        const labelX = x - labelWidth / 2;
                        const labelY = y - labelHeight - 8;

                        ctx.beginPath();
                        // Use roundRect if available, otherwise fallback to regular rect
                        if (ctx.roundRect) {
                            ctx.roundRect(labelX, labelY, labelWidth, labelHeight, 4);
                        } else {
                            ctx.rect(labelX, labelY, labelWidth, labelHeight);
                        }
                        ctx.fill();

                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetY = 0;

                        // Label text
                        ctx.fillStyle = '#1f2937';
                        ctx.font = 'bold 10px -apple-system, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(entry.weight + ' kg', x, y - 13);
                    }
                });

                // X-axis date labels
                const labelIndices = chartData.length <= 7
                    ? chartData.map((_, i) => i)
                    : [0, Math.floor(chartData.length / 2), chartData.length - 1];

                labelIndices.forEach(i => {
                    const x = padding.left + (chartWidth / (chartData.length - 1)) * i;
                    const date = new Date(chartData[i].date);
                    const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '10px -apple-system, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(label, x, height - padding.bottom + 20);
                });
            }
        }

        // Handle Enter key in weight input
        function handleWeightKeyPress(event) {
            if (event.key === 'Enter') {
                addWeight();
            }
        }

        // Initialize weight tracker on page load
        window.addEventListener('load', function() {
            loadWeightData();
            initWeightSection();

            if (window.firebaseReady) {
                loadWeightFromCloud();
            }
        });

        // ===== INDIAN DATE/TIME DISPLAY =====
        function updateIndianDateTime() {
            const now = new Date();
            const options = {
                timeZone: 'Asia/Kolkata',
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const indianTime = now.toLocaleString('en-IN', options);
            const dateTimeElement = document.getElementById('indian-datetime');
            if (dateTimeElement) {
                dateTimeElement.textContent = indianTime + ' IST';
            }
        }

        // Update time every second
        setInterval(updateIndianDateTime, 1000);
        updateIndianDateTime(); // Initial call

        // ===== BIRTHDAY TRACKER =====
        let birthdays = [];
        let birthdayExpanded = false;

        // Load birthdays from localStorage
        function loadBirthdaysLocal() {
            const stored = localStorage.getItem('birthdays');
            if (stored) {
                try {
                    birthdays = JSON.parse(stored);
                } catch (error) {
                    console.error('Error parsing birthdays:', error);
                    birthdays = [];
                }
            }
        }

        // Save birthdays to localStorage
        function saveBirthdaysLocal() {
            localStorage.setItem('birthdays', JSON.stringify(birthdays));
        }

        // Save birthdays to Firebase
        async function saveBirthdaysToCloud() {
            if (window.firebaseReady && window.db) {
                try {
                    const userId = getUserId();
                    const userDocRef = window.firestoreDoc(window.db, 'users', userId);

                    await window.firestoreSetDoc(userDocRef, {
                        birthdays: birthdays,
                        lastModified: new Date().toISOString()
                    }, { merge: true });
                    console.log('✅ Birthdays saved to cloud');
                } catch (error) {
                    console.error('Error saving birthdays to cloud:', error);
                }
            }
        }

        // Load birthdays from Firebase
        async function loadBirthdaysFromCloud() {
            if (window.firebaseReady && window.db) {
                try {
                    const userId = getUserId();
                    const userDocRef = window.firestoreDoc(window.db, 'users', userId);
                    const doc = await window.firestoreGetDoc(userDocRef);

                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.birthdays) {
                            birthdays = data.birthdays;
                            saveBirthdaysLocal();
                            renderBirthdays();
                            checkBirthdaysToday();
                            console.log('✅ Birthdays loaded from cloud');
                        }
                    }
                } catch (error) {
                    console.error('Error loading birthdays from cloud:', error);
                }
            }
        }

        // Add birthday
        function addBirthday() {
            const nameInput = document.getElementById('birthday-name-input');
            const dateInput = document.getElementById('birthday-date-input');
            const name = nameInput.value.trim();
            const date = dateInput.value;

            if (!name || !date) {
                alert('Please enter both name and date');
                return;
            }

            birthdays.push({
                id: Date.now(),
                name: name,
                date: date
            });

            // Sort by month/day
            birthdays.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getMonth() !== dateB.getMonth()) {
                    return dateA.getMonth() - dateB.getMonth();
                }
                return dateA.getDate() - dateB.getDate();
            });

            saveBirthdaysLocal();
            saveBirthdaysToCloud();
            renderBirthdays();
            checkBirthdaysToday();

            nameInput.value = '';
            dateInput.value = '';
        }

        // Delete birthday
        function deleteBirthday(id) {
            birthdays = birthdays.filter(b => b.id !== id);
            saveBirthdaysLocal();
            saveBirthdaysToCloud();
            renderBirthdays();
            checkBirthdaysToday();
        }

        // Check if today is someone's birthday
        function checkBirthdaysToday() {
            const today = new Date();
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();

            const todayBirthdays = birthdays.filter(b => {
                const bDay = new Date(b.date);
                return bDay.getMonth() === todayMonth && bDay.getDate() === todayDate;
            });

            const notificationDiv = document.getElementById('birthday-notification');
            if (todayBirthdays.length > 0) {
                const names = todayBirthdays.map(b => b.name).join(', ');
                notificationDiv.innerHTML = `
                    <div class="birthday-notification">
                        <div class="birthday-notification-text">Today is ${names}'s birthday!</div>
                    </div>
                `;
                notificationDiv.style.display = 'block';

                // Show browser notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Birthday Reminder', {
                        body: `Today is ${names}'s birthday!`,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ec4899"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>'
                    });
                }
            } else {
                notificationDiv.style.display = 'none';
            }
        }

        // Check if birthday is upcoming (within 7 days)
        function isUpcoming(date) {
            const today = new Date();
            const birthday = new Date(date);
            birthday.setFullYear(today.getFullYear());

            if (birthday < today) {
                birthday.setFullYear(today.getFullYear() + 1);
            }

            const diffTime = birthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays > 0 && diffDays <= 7;
        }

        // Check if today is the birthday
        function isToday(date) {
            const today = new Date();
            const birthday = new Date(date);
            return today.getMonth() === birthday.getMonth() && today.getDate() === birthday.getDate();
        }

        // Render birthdays
        function renderBirthdays() {
            const listElement = document.getElementById('birthdays-list');
            const countElement = document.getElementById('birthday-count');

            if (countElement) {
                countElement.textContent = birthdays.length;
            }

            if (birthdays.length === 0) {
                listElement.innerHTML = '<div class="empty-state">No birthdays yet. Add one above!</div>';

                // Update maxHeight if expanded
                if (birthdayExpanded) {
                    const content = document.getElementById('birthday-content');
                    setTimeout(() => {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }, 10);
                }
                return;
            }

            listElement.innerHTML = birthdays.map(birthday => {
                const bDate = new Date(birthday.date);
                const formattedDate = bDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                const todayClass = isToday(birthday.date) ? 'today' : (isUpcoming(birthday.date) ? 'upcoming' : '');

                let daysInfo = '';
                if (isToday(birthday.date)) {
                    daysInfo = ' • Today!';
                } else if (isUpcoming(birthday.date)) {
                    const today = new Date();
                    const bday = new Date(birthday.date);
                    bday.setFullYear(today.getFullYear());
                    if (bday < today) bday.setFullYear(today.getFullYear() + 1);
                    const days = Math.ceil((bday - today) / (1000 * 60 * 60 * 24));
                    daysInfo = ` • In ${days} day${days > 1 ? 's' : ''}`;
                }

                return `
                    <div class="birthday-item ${todayClass}">
                        <div class="birthday-info">
                            <div class="birthday-name">${birthday.name}</div>
                            <div class="birthday-date">${formattedDate}${daysInfo}</div>
                        </div>
                        <button class="birthday-delete" onclick="deleteBirthday(${birthday.id})">Delete</button>
                    </div>
                `;
            }).join('');

            // Update maxHeight if expanded
            if (birthdayExpanded) {
                const content = document.getElementById('birthday-content');
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }, 10);
            }
        }

        // Toggle birthday section
        function toggleBirthdaySection() {
            birthdayExpanded = !birthdayExpanded;
            const content = document.getElementById('birthday-content');
            const toggleBtn = document.getElementById('birthday-toggle-btn');

            if (birthdayExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                toggleBtn.textContent = '▲';
            } else {
                content.style.maxHeight = '0';
                toggleBtn.textContent = '▼';
            }
        }

        // Clear all birthdays
        function clearAllBirthdays() {
            if (birthdays.length === 0) return;

            if (confirm('Are you sure you want to delete all birthdays?')) {
                birthdays = [];
                saveBirthdaysLocal();
                saveBirthdaysToCloud();
                renderBirthdays();
                checkBirthdaysToday();
            }
        }

        // Initialize birthday section
        function initBirthdaySection() {
            const content = document.getElementById('birthday-content');
            const toggleBtn = document.getElementById('birthday-toggle-btn');

            // Start expanded
            birthdayExpanded = true;
            content.style.maxHeight = content.scrollHeight + 'px';
            toggleBtn.textContent = '▲';
        }

        // Initialize birthdays on page load
        window.addEventListener('load', function() {
            loadBirthdaysLocal();
            initBirthdaySection();
            renderBirthdays();
            checkBirthdaysToday();

            // Check birthdays daily
            setInterval(checkBirthdaysToday, 60000); // Check every minute

            if (window.firebaseReady) {
                loadBirthdaysFromCloud();
            }
        });

        // ===== REMINDERS SECTION =====
        let reminders = [];
        let remindersExpanded = false;

        // Load reminders from localStorage
        function loadRemindersLocal() {
            const stored = localStorage.getItem('reminders');
            if (stored) {
                try {
                    reminders = JSON.parse(stored);
                } catch (error) {
                    console.error('Error parsing reminders:', error);
                    reminders = [];
                }
            }
        }

        // Save reminders to localStorage
        function saveRemindersLocal() {
            localStorage.setItem('reminders', JSON.stringify(reminders));
        }

        // Save reminders to Firebase
        async function saveRemindersToCloud() {
            if (window.firebaseReady && window.db) {
                try {
                    const userId = getUserId();
                    const userDocRef = window.firestoreDoc(window.db, 'users', userId);

                    await window.firestoreSetDoc(userDocRef, {
                        reminders: reminders,
                        lastModified: new Date().toISOString()
                    }, { merge: true });
                    console.log('✅ Reminders saved to cloud');
                } catch (error) {
                    console.error('Error saving reminders to cloud:', error);
                }
            }
        }

        // Load reminders from Firebase
        async function loadRemindersFromCloud() {
            if (window.firebaseReady && window.db) {
                try {
                    const userId = getUserId();
                    const userDocRef = window.firestoreDoc(window.db, 'users', userId);
                    const doc = await window.firestoreGetDoc(userDocRef);

                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.reminders) {
                            reminders = data.reminders;
                            saveRemindersLocal();
                            renderReminders();
                            checkReminders();
                            console.log('✅ Reminders loaded from cloud');
                        }
                    }
                } catch (error) {
                    console.error('Error loading reminders from cloud:', error);
                }
            }
        }

        // Calculate next due date based on frequency
        function calculateNextDueDate(currentDate, frequency) {
            const date = new Date(currentDate);

            switch(frequency) {
                case 'daily':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
                case 'quarterly':
                    date.setMonth(date.getMonth() + 3);
                    break;
                case 'half-yearly':
                    date.setMonth(date.getMonth() + 6);
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + 1);
                    break;
            }

            return date.toISOString().split('T')[0];
        }

        // Add reminder
        function addReminder() {
            const nameInput = document.getElementById('reminder-name-input');
            const frequencyInput = document.getElementById('reminder-frequency-input');
            const typeInput = document.getElementById('reminder-type-input');
            const dateInput = document.getElementById('reminder-date-input');
            const amountInput = document.getElementById('reminder-amount-input');

            const name = nameInput.value.trim();
            const frequency = frequencyInput.value;
            const type = typeInput.value || 'expense'; // Default to expense
            const dueDate = dateInput.value;
            const amount = amountInput.value ? parseFloat(amountInput.value) : null;

            if (!name || !frequency || !dueDate) {
                alert('Please fill in name, frequency, and due date');
                return;
            }

            reminders.push({
                id: Date.now(),
                name: name,
                frequency: frequency,
                type: type,
                dueDate: dueDate,
                amount: amount,
                createdAt: new Date().toISOString()
            });

            // Sort by due date
            reminders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            saveRemindersLocal();
            saveRemindersToCloud();
            renderReminders();
            checkReminders();

            nameInput.value = '';
            frequencyInput.value = '';
            typeInput.value = '';
            dateInput.value = '';
            amountInput.value = '';
        }

        // Delete reminder
        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            saveRemindersLocal();
            saveRemindersToCloud();
            renderReminders();
            checkReminders();
        }

        // Mark reminder as paid and update to next due date
        function markReminderPaid(id) {
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                reminder.dueDate = calculateNextDueDate(reminder.dueDate, reminder.frequency);
                reminders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                saveRemindersLocal();
                saveRemindersToCloud();
                renderReminders();
                checkReminders();
            }
        }

        // Check for due/upcoming reminders
        function checkReminders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const overdue = reminders.filter(r => {
                const dueDate = new Date(r.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate < today;
            });

            const dueToday = reminders.filter(r => {
                const dueDate = new Date(r.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate.getTime() === today.getTime();
            });

            const dueSoon = reminders.filter(r => {
                const dueDate = new Date(r.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 7;
            });

            const notificationDiv = document.getElementById('reminders-notification');
            if (overdue.length > 0 || dueToday.length > 0 || dueSoon.length > 0) {
                let message = '';
                if (overdue.length > 0) {
                    message += `${overdue.length} overdue reminder${overdue.length > 1 ? 's' : ''}`;
                }
                if (dueToday.length > 0) {
                    if (message) message += ' • ';
                    message += `${dueToday.length} due today`;
                }
                if (dueSoon.length > 0) {
                    if (message) message += ' • ';
                    message += `${dueSoon.length} due within 7 days`;
                }

                notificationDiv.innerHTML = `
                    <div class="reminder-notification">
                        <div class="reminder-notification-text">${message}</div>
                    </div>
                `;
                notificationDiv.style.display = 'block';

                // Show browser notification for overdue or due today
                if ((overdue.length > 0 || dueToday.length > 0) && 'Notification' in window && Notification.permission === 'granted') {
                    let notifBody = '';
                    if (dueToday.length > 0) {
                        const names = dueToday.map(r => r.name).join(', ');
                        notifBody = `Due today: ${names}`;
                    } else if (overdue.length > 0) {
                        const names = overdue.slice(0, 3).map(r => r.name).join(', ');
                        notifBody = `Overdue: ${names}${overdue.length > 3 ? ' and more' : ''}`;
                    }

                    new Notification('Payment Reminder', {
                        body: notifBody,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f59e0b"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>'
                    });
                }
            } else {
                notificationDiv.style.display = 'none';
            }
        }

        // Check if reminder is overdue
        function isOverdue(dueDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            return due < today;
        }

        // Check if reminder is due soon (within 7 days)
        function isDueSoon(dueDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            return diffDays >= 0 && diffDays <= 7;
        }

        // Render reminders
        function renderReminders() {
            const listElement = document.getElementById('reminders-list');
            const countElement = document.getElementById('reminders-count');

            if (countElement) {
                countElement.textContent = reminders.length;
            }

            // Calculate totals
            let totalLiabilities = 0;
            let totalInvestments = 0;
            let totalExpenses = 0;

            reminders.forEach(reminder => {
                if (reminder.amount) {
                    const type = reminder.type || 'expense';
                    if (type === 'liability') totalLiabilities += reminder.amount;
                    else if (type === 'investment') totalInvestments += reminder.amount;
                    else totalExpenses += reminder.amount;
                }
            });

            if (reminders.length === 0) {
                listElement.innerHTML = '<div class="empty-state">No reminders yet. Add one above!</div>';

                // Update maxHeight if expanded
                if (remindersExpanded) {
                    const content = document.getElementById('reminders-content');
                    setTimeout(() => {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }, 10);
                }
                return;
            }

            // Add totals summary at the top
            let totalsHTML = '<div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #86efac;">';
            totalsHTML += '<div style="font-size: 11px; font-weight: 600; color: #166534; margin-bottom: 6px;">FINANCIAL SUMMARY</div>';
            totalsHTML += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px;">';
            if (totalLiabilities > 0) {
                totalsHTML += `<div style="background: white; padding: 6px 8px; border-radius: 6px; border: 1px solid #fca5a5;">
                    <div style="color: #991b1b; font-weight: 600;">Liabilities</div>
                    <div style="color: #dc2626; font-weight: 700; font-size: 13px;">₹${totalLiabilities.toLocaleString('en-IN')}</div>
                </div>`;
            }
            if (totalInvestments > 0) {
                totalsHTML += `<div style="background: white; padding: 6px 8px; border-radius: 6px; border: 1px solid #93c5fd;">
                    <div style="color: #1e3a8a; font-weight: 600;">Investments</div>
                    <div style="color: #2563eb; font-weight: 700; font-size: 13px;">₹${totalInvestments.toLocaleString('en-IN')}</div>
                </div>`;
            }
            if (totalExpenses > 0) {
                totalsHTML += `<div style="background: white; padding: 6px 8px; border-radius: 6px; border: 1px solid #fde047;">
                    <div style="color: #713f12; font-weight: 600;">Expenses</div>
                    <div style="color: #ca8a04; font-weight: 700; font-size: 13px;">₹${totalExpenses.toLocaleString('en-IN')}</div>
                </div>`;
            }
            totalsHTML += '</div></div>';

            listElement.innerHTML = totalsHTML + reminders.map(reminder => {
                const dueDate = new Date(reminder.dueDate);
                const formattedDate = dueDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const due = new Date(reminder.dueDate);
                due.setHours(0, 0, 0, 0);
                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

                let statusClass = '';
                let daysInfo = '';

                if (isOverdue(reminder.dueDate)) {
                    statusClass = 'overdue';
                    daysInfo = ` • ${Math.abs(diffDays)} day${Math.abs(diffDays) > 1 ? 's' : ''} overdue`;
                } else if (isDueSoon(reminder.dueDate)) {
                    statusClass = 'due-soon';
                    if (diffDays === 0) {
                        daysInfo = ' • Due today';
                    } else {
                        daysInfo = ` • Due in ${diffDays} day${diffDays > 1 ? 's' : ''}`;
                    }
                }

                const type = reminder.type || 'expense';
                let typeBadgeColor = '';
                let typeBadgeBg = '';
                if (type === 'liability') {
                    typeBadgeColor = '#991b1b';
                    typeBadgeBg = '#fee2e2';
                } else if (type === 'investment') {
                    typeBadgeColor = '#1e3a8a';
                    typeBadgeBg = '#dbeafe';
                } else {
                    typeBadgeColor = '#713f12';
                    typeBadgeBg = '#fef9c3';
                }

                const typeBadge = `<span style="background: ${typeBadgeBg}; color: ${typeBadgeColor}; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">${type}</span>`;
                const amountText = reminder.amount ? ` • ₹${reminder.amount.toLocaleString('en-IN')}` : '';

                return `
                    <div class="reminder-item ${statusClass}">
                        <div class="reminder-info">
                            <div class="reminder-name">${escapeHtml(reminder.name)}</div>
                            <div class="reminder-details">
                                <span class="reminder-frequency">${reminder.frequency}</span>
                                ${typeBadge}
                                <span>${formattedDate}${daysInfo}${amountText}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="recommend-btn" onclick="markReminderPaid(${reminder.id})" style="font-size: 10px; padding: 5px 10px; white-space: nowrap;">Mark Paid</button>
                            <button class="reminder-delete" onclick="deleteReminder(${reminder.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Update maxHeight if expanded
            if (remindersExpanded) {
                const content = document.getElementById('reminders-content');
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }, 10);
            }
        }

        // Toggle reminders section
        function toggleRemindersSection() {
            remindersExpanded = !remindersExpanded;
            const content = document.getElementById('reminders-content');
            const toggleBtn = document.getElementById('reminders-toggle-btn');

            if (remindersExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                toggleBtn.textContent = '▲';
            } else {
                content.style.maxHeight = '0';
                toggleBtn.textContent = '▼';
            }
        }

        // Clear all reminders
        function clearAllReminders() {
            if (reminders.length === 0) return;

            if (confirm('Are you sure you want to delete all reminders?')) {
                reminders = [];
                saveRemindersLocal();
                saveRemindersToCloud();
                renderReminders();
                checkReminders();
            }
        }

        // Initialize reminders section
        function initRemindersSection() {
            const content = document.getElementById('reminders-content');
            const toggleBtn = document.getElementById('reminders-toggle-btn');

            // Start expanded
            remindersExpanded = true;
            content.style.maxHeight = content.scrollHeight + 'px';
            toggleBtn.textContent = '▲';
        }

        // Initialize reminders on page load
        window.addEventListener('load', function() {
            loadRemindersLocal();
            initRemindersSection();
            renderReminders();
            checkReminders();

            // Check reminders daily
            setInterval(checkReminders, 60000); // Check every minute

            if (window.firebaseReady) {
                loadRemindersFromCloud();
            }
        });

        // ===== WATER TRACKER =====
        let waterData = {};
        let waterLogExpanded = false;

        function getTodayDateWater() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function loadWaterData() {
            const stored = localStorage.getItem('waterTracker');
            if (stored) {
                try {
                    waterData = JSON.parse(stored);
                } catch (error) {
                    console.error('Error parsing water data:', error);
                    waterData = {};
                }
            }

            const today = getTodayDateWater();
            if (!waterData[today]) {
                waterData[today] = {
                    glasses: 0,
                    log: []
                };
            }

            renderWaterTracker();
        }

        function saveWaterData() {
            localStorage.setItem('waterTracker', JSON.stringify(waterData));

            // Save to cloud
            if (window.firebaseReady && window.db) {
                const userId = getUserId();
                const userDocRef = window.firestoreDoc(window.db, 'users', userId);
                window.firestoreSetDoc(userDocRef, {
                    waterTracker: waterData,
                    lastModified: new Date().toISOString()
                }, { merge: true }).catch(error => {
                    console.error('Error saving water data to cloud:', error);
                });
            }
        }

        function addWaterGlass() {
            const today = getTodayDateWater();
            if (!waterData[today]) {
                waterData[today] = { glasses: 0, log: [] };
            }

            if (waterData[today].glasses < 8) {
                waterData[today].glasses++;
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                waterData[today].log.push({
                    time: timeStr,
                    timestamp: now.toISOString()
                });

                saveWaterData();
                renderWaterTracker();

                // Show celebration when complete
                if (waterData[today].glasses === 8) {
                    setTimeout(() => {
                        alert('Congratulations! You completed your daily water goal!');
                    }, 300);
                }
            }
        }

        function removeWaterGlass() {
            const today = getTodayDateWater();
            if (!waterData[today]) {
                waterData[today] = { glasses: 0, log: [] };
            }

            if (waterData[today].glasses > 0) {
                waterData[today].glasses--;
                waterData[today].log.pop(); // Remove last log entry

                saveWaterData();
                renderWaterTracker();
            }
        }

        function resetWater() {
            if (confirm('Reset today\'s water tracker?')) {
                const today = getTodayDateWater();
                waterData[today] = { glasses: 0, log: [] };
                saveWaterData();
                renderWaterTracker();
            }
        }

        function toggleWaterLog() {
            waterLogExpanded = !waterLogExpanded;
            const container = document.getElementById('water-log-container');
            const toggleBtn = document.getElementById('water-log-toggle');

            if (waterLogExpanded) {
                container.style.maxHeight = '200px';
                toggleBtn.textContent = '▲';
            } else {
                container.style.maxHeight = '0';
                toggleBtn.textContent = '▼';
            }
        }

        function renderWaterTracker() {
            const today = getTodayDateWater();
            if (!waterData[today]) {
                waterData[today] = { glasses: 0, log: [] };
            }

            const glasses = waterData[today].glasses;
            const progress = document.getElementById('water-progress');
            const glassesContainer = document.getElementById('water-glasses');
            const waterDate = document.getElementById('water-date');
            const logList = document.getElementById('water-log-list');

            progress.textContent = `${glasses}/8`;

            // Update date
            const todayDate = new Date();
            waterDate.textContent = todayDate.toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' });

            // Render glasses
            glassesContainer.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const isFilled = i < glasses;
                const isLastFilled = i === glasses - 1; // Only last filled glass can be undone
                const glass = document.createElement('button');
                glass.className = 'habit-btn';
                glass.style.cssText = `
                    padding: 16px 12px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                    background: ${isFilled ? 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' : 'white'};
                    border: 2px solid ${isFilled ? '#3b82f6' : '#e8e8e8'};
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                `;

                glass.innerHTML = `
                    <div style="font-size: 24px;">${isFilled ? '💧' : '🥛'}</div>
                    <div style="font-size: 10px; font-weight: 600; color: ${isFilled ? '#1e3a8a' : '#9ca3af'};">Glass ${i + 1}</div>
                    ${isLastFilled ? '<div style="position: absolute; top: 4px; right: 4px; font-size: 10px; color: #ef4444;">×</div>' : ''}
                `;

                if (!isFilled) {
                    glass.onclick = addWaterGlass;
                    glass.onmouseover = function() {
                        this.style.borderColor = '#3b82f6';
                        this.style.transform = 'translateY(-2px)';
                    };
                    glass.onmouseout = function() {
                        this.style.borderColor = '#e8e8e8';
                        this.style.transform = 'translateY(0)';
                    };
                } else if (isLastFilled) {
                    // Only last filled glass can be removed
                    glass.onclick = removeWaterGlass;
                    glass.onmouseover = function() {
                        this.style.borderColor = '#ef4444';
                        this.style.transform = 'translateY(-2px)';
                        this.style.opacity = '0.8';
                    };
                    glass.onmouseout = function() {
                        this.style.borderColor = '#3b82f6';
                        this.style.transform = 'translateY(0)';
                        this.style.opacity = '1';
                    };
                } else {
                    // Other filled glasses are not clickable
                    glass.style.cursor = 'default';
                }

                glassesContainer.appendChild(glass);
            }

            // Render log
            if (waterData[today].log && waterData[today].log.length > 0) {
                logList.innerHTML = waterData[today].log.map((entry, index) => `
                    <div style="padding: 6px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6;">
                        <span>💧 Glass ${index + 1}</span>
                        <span style="color: #9ca3af;">${entry.time}</span>
                    </div>
                `).join('');
            } else {
                logList.innerHTML = '<div style="padding: 8px; text-align: center; color: #9ca3af;">No glasses logged today</div>';
            }
        }

        // Initialize water tracker on page load
        window.addEventListener('load', function() {
            loadWaterData();

            // Check for day change every minute
            setInterval(function() {
                const today = getTodayDateWater();
                if (!waterData[today]) {
                    console.log('New day detected! Resetting water tracker...');
                    loadWaterData();
                }
            }, 60000);
        });
    </script>
</body>
</html>